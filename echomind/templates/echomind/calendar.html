{% extends "echomind/base.html" %}

{% block title %}Weekly Calendar - Echo Mind{% endblock %}

{% block extra_style %}
/* Mobile optimization - reduce side margins */
@media (max-width: 768px) {
    body {
        padding-left: 5px !important;
        padding-right: 5px !important;
    }
}

/* Calendar Header */
.calendar-header {
    background: white;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .calendar-header {
        padding: 6px 4px;
        border-radius: 6px;
    }
}

.week-nav {
    display: flex;
    align-items: center;
}

.week-nav button {
    background: linear-gradient(135deg, #C7CEEA 0%, #B5EAD7 100%);
    color: #333;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
}

@media (max-width: 768px) {
    .week-nav button {
        padding: 6px 10px;
        font-size: 12px;
    }
}

.week-nav button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.week-nav button:active {
    transform: translateY(0);
}

/* Calendar Grid */
.calendar-container {
    background: white;
    border-radius: 8px;
    overflow-x: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 80px;
    -webkit-overflow-scrolling: touch;
}

.calendar-grid {
    display: grid;
    grid-template-columns: 45px repeat(7, minmax(50px, 1fr));
    width: 100%;
}

@media (max-width: 768px) {
    .calendar-grid {
        grid-template-columns: 35px repeat(7, minmax(45px, 1fr));
    }
}

/* Time labels */
.time-label {
    grid-column: 1;
    padding: 6px 2px;
    font-size: 11px;
    color: #666;
    border-right: 1px solid #eee;
    border-bottom: 1px solid #eee;
    text-align: center;
}

@media (max-width: 768px) {
    .time-label {
        padding: 4px 1px;
        font-size: 10px;
    }
}

/* Day headers */
.day-header {
    padding: 10px 2px;
    text-align: center;
    font-weight: bold;
    font-size: 11px;
    color: #333;
    border-bottom: 2px solid #007bff;
    background: #f8f9fa;
    line-height: 1.3;
}

@media (max-width: 768px) {
    .day-header {
        padding: 8px 1px;
        font-size: 10px;
    }
}

.day-header.today {
    background: #e7f3ff;
    color: #007bff;
}

/* Time slots */
.time-slot {
    min-height: 40px;
    border-right: 1px solid #eee;
    border-bottom: 1px solid #eee;
    position: relative;
    cursor: pointer;
    transition: background 0.2s;
}

.time-slot:hover {
    background: #f8f9fa;
}

.time-slot.today {
    background: #f0f8ff;
}

.time-slot.today:hover {
    background: #e0f0ff;
}

/* Plan blocks */
.plan-block {
    position: absolute;
    left: 1px;
    right: 1px;
    border-radius: 3px;
    padding: 3px 2px;
    font-size: 9px;
    color: #333;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.1);
    transition: all 0.2s;
    line-height: 1.1;
    font-weight: 500;
}

@media (max-width: 768px) {
    .plan-block {
        padding: 2px 1px;
        font-size: 8px;
        border-radius: 2px;
    }
}

.plan-block:hover {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    z-index: 10;
}

.plan-block.completed {
    opacity: 0.7;
    border: 2px solid #28a745;
}

/* Category colors are now dynamically applied via JavaScript using plan.color field */

/* Add Plan Modal */
.modal-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 10000 !important;
    align-items: center;
    justify-content: center;
}

.modal-backdrop.show {
    display: flex !important;
}

.modal-content {
    background: white !important;
    border-radius: 12px;
    padding: 20px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    position: relative;
    z-index: 10001 !important;
    opacity: 1 !important;
}

@media (max-width: 768px) {
    .modal-content {
        padding: 15px;
        width: 95%;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.modal-title {
    font-size: 18px;
    font-weight: bold;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #999;
    cursor: pointer;
}

.form-group {
    margin-bottom: 15px;
}

@media (max-width: 768px) {
    .form-group {
        margin-bottom: 12px;
    }
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 14px;
}

@media (max-width: 768px) {
    .form-group label {
        font-size: 13px;
        margin-bottom: 4px;
    }
}

.category-buttons {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.category-btn {
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

.category-btn.selected {
    border-color: #007bff;
    background: #e7f3ff;
    font-weight: bold;
}

.time-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

@media (max-width: 768px) {
    .time-inputs {
        gap: 6px;
    }

    .time-inputs .form-control {
        padding: 8px 6px !important;
        font-size: 14px !important;
    }
}
{% endblock %}

{% block content %}
<div class="calendar-header">
    <div class="week-nav" style="justify-content: center; gap: 10px;">
        <button onclick="changeWeek(-1)">← 이전주</button>
        <button onclick="goToToday()" style="background: linear-gradient(135deg, #FFD9BA 0%, #FFFFBA 100%); color: #333; border: none; padding: 8px 15px; border-radius: 6px; font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';">오늘</button>
        <button onclick="changeWeek(1)">다음주 →</button>
    </div>
</div>

<div class="calendar-container">
    <div class="calendar-grid" id="calendarGrid">
        <!-- Grid will be populated by JavaScript -->
    </div>
</div>

<!-- Add Plan Modal -->
<div class="modal-backdrop" id="planModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">계획 추가</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="planForm">
            <div class="form-group">
                <label>날짜</label>
                <input type="date" class="form-control" id="planDate" readonly>
            </div>
            <div class="form-group">
                <label>카테고리</label>
                <div class="category-buttons" id="categoryButtons">
                    {% for category in activity_categories %}
                    <button type="button" class="category-btn" data-id="{{ category.id }}" data-name="{{ category.name }}">
                        {{ category.name }}
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div class="form-group">
                <label>시간</label>
                <div class="time-inputs">
                    <input type="time" class="form-control" id="startTime" required>
                    <input type="time" class="form-control" id="endTime" required>
                </div>
            </div>
            <div class="form-group">
                <label>메모 (선택)</label>
                <textarea class="form-control" id="planNote" rows="2"></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-submit">저장</button>
        </form>
    </div>
</div>

<!-- Plan Detail Modal -->
<div class="modal-backdrop" id="planDetailModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="planDetailTitle">계획 상세</h3>
            <button class="modal-close" onclick="closePlanDetailModal()">&times;</button>
        </div>
        <div id="planDetailBody"></div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="deleteModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">계획 삭제</h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <p>이 계획을 삭제하시겠습니까?</p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">취소</button>
            <button class="btn btn-danger" onclick="confirmDelete()">삭제</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_script %}
let currentDate = new Date();
let selectedCategoryId = null;
let planToDelete = null;

const HOURS = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
const DAYS = ['월', '화', '수', '목', '금', '토', '일'];

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Category button selection
    document.getElementById('categoryButtons').addEventListener('click', (e) => {
        if (e.target.classList.contains('category-btn')) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            selectedCategoryId = e.target.dataset.id;
        }
    });

    // Form submit
    document.getElementById('planForm').addEventListener('submit', handleFormSubmit);

    // Load calendar on page load
    loadCalendar();
});

function getMonday(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
    d.setDate(diff);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function changeWeek(delta) {
    currentDate.setDate(currentDate.getDate() + (delta * 7));
    console.log('Changed to date:', formatDate(currentDate));
    loadCalendar();
}

function goToToday() {
    currentDate = new Date();
    console.log('Go to today:', formatDate(currentDate));
    loadCalendar();
}

function goToDailyView(dateStr) {
    window.location.href = `/echomind/timeline/?date=${dateStr}`;
}

function loadCalendar() {
    const monday = getMonday(currentDate);
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);

    console.log('Loading calendar - Monday:', formatDate(monday), 'Sunday:', formatDate(sunday));

    // Build grid
    buildCalendarGrid(monday);

    // Load plans
    const apiUrl = `/echomind/api/plans/by-week/?date=${formatDate(monday)}`;
    console.log('Fetching plans from:', apiUrl);

    fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
            console.log('Plans API response:', data);
            if (data.success) {
                renderPlans(data.plans, monday);
            }
        })
        .catch(err => console.error('Error loading plans:', err));
}

function buildCalendarGrid(monday) {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Header row
    grid.innerHTML += '<div class="time-label"></div>'; // Top-left corner
    for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        const isToday = date.getTime() === today.getTime();
        const dateStr = formatDate(date);
        grid.innerHTML += `
            <div class="day-header ${isToday ? 'today' : ''}"
                 style="cursor: pointer;"
                 onclick="goToDailyView('${dateStr}')"
                 title="클릭하여 일간 보기로 이동">
                ${DAYS[i]}<br>${date.getMonth() + 1}/${date.getDate()}
            </div>
        `;
    }

    // Time rows
    HOURS.forEach(hour => {
        grid.innerHTML += `<div class="time-label">${hour}:00</div>`;
        for (let i = 0; i < 7; i++) {
            const date = new Date(monday);
            date.setDate(monday.getDate() + i);
            const isToday = date.getTime() === today.getTime();
            grid.innerHTML += `
                <div class="time-slot ${isToday ? 'today' : ''}"
                     data-date="${formatDate(date)}"
                     data-hour="${hour}"
                     onclick="handleTimeSlotClick(event, '${formatDate(date)}', ${hour})">
                </div>
            `;
        }
    });
}

function renderPlans(plans, monday) {
    console.log('Rendering plans:', plans);

    plans.forEach(plan => {
        const planDate = new Date(plan.date);
        const dayIndex = Math.floor((planDate - monday) / (1000 * 60 * 60 * 24));

        if (dayIndex < 0 || dayIndex > 6) {
            console.log('Plan outside week range:', plan);
            return;
        }

        const startHour = parseInt(plan.start_time.split(':')[0]);
        const endHour = parseInt(plan.end_time.split(':')[0]);
        const startMin = parseInt(plan.start_time.split(':')[1]);
        const endMin = parseInt(plan.end_time.split(':')[1]);

        // Skip if entirely outside visible hours (6-24)
        if (endHour < 6 || startHour >= 24) {
            console.log('Plan outside visible hours:', plan);
            return;
        }

        // Clamp to visible hours
        const clampedStartHour = Math.max(6, startHour);
        const clampedEndHour = Math.min(24, endHour);
        const clampedStartMin = startHour < 6 ? 0 : startMin;
        const clampedEndMin = endHour >= 24 ? 0 : endMin;

        // Find start slot
        const startSlotHour = clampedStartHour === 24 ? 23 : clampedStartHour;
        const startSlot = document.querySelector(
            `.time-slot[data-date="${plan.date}"][data-hour="${startSlotHour}"]`
        );

        if (!startSlot) {
            console.log('Start slot not found for plan:', plan, 'hour:', startSlotHour);
            return;
        }

        // Calculate position and height
        const hourHeight = 40; // min-height of time-slot
        const totalMinutes = (clampedEndHour * 60 + clampedEndMin) - (clampedStartHour * 60 + clampedStartMin);
        const height = (totalMinutes / 60) * hourHeight;

        // Top offset relative to start slot
        const topOffset = clampedStartHour === startHour ? (startMin / 60) * hourHeight : 0;

        const completedClass = plan.has_activity ? 'completed' : '';

        // Parse color from plan (format: "color1,color2")
        const colors = plan.color ? plan.color.split(',') : ['#667eea', '#764ba2'];
        const gradientBg = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%)`;

        const block = document.createElement('div');
        block.className = `plan-block ${completedClass}`;
        block.style.top = `${topOffset}px`;
        block.style.height = `${Math.max(height, 10)}px`; // Minimum 10px
        block.style.background = gradientBg;

        // Short text for small blocks
        if (height < 30) {
            block.innerHTML = `${plan.category.substring(0, 3)}`;
        } else {
            block.innerHTML = `${plan.category}<br><span style="font-size: 8px;">${plan.start_time.substring(0, 5)}</span>`;
        }

        block.title = `${plan.category} (${plan.start_time}-${plan.end_time})`;

        // Setup long press to delete
        setupLongPress(block, () => deletePlan(plan.id), () => showPlanDetails(plan));

        console.log('Appending plan block:', {
            date: plan.date,
            category: plan.category,
            time: `${plan.start_time}-${plan.end_time}`,
            slotHour: startSlotHour,
            height: height,
            topOffset: topOffset
        });

        startSlot.appendChild(block);
    });
}

function handleTimeSlotClick(event, date, hour) {
    // Only open modal if the time-slot itself was clicked (not a child element like plan-block)
    if (event.target.classList.contains('time-slot')) {
        openAddPlanModal(date, hour);
    }
}

function openAddPlanModal(date, hour) {
    document.getElementById('planDate').value = date;
    document.getElementById('startTime').value = `${String(hour).padStart(2, '0')}:00`;
    document.getElementById('endTime').value = `${String(hour + 1).padStart(2, '0')}:00`;
    document.getElementById('planNote').value = '';
    selectedCategoryId = null;
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));

    const modal = document.getElementById('planModal');
    modal.classList.add('show');
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
    modal.style.opacity = '1';

    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.backgroundColor = 'white';
    modalContent.style.opacity = '1';
    modalContent.style.zIndex = '10001';
}

function closeModal() {
    const modal = document.getElementById('planModal');
    modal.classList.remove('show');
    modal.style.display = 'none';
}

function openDeleteModal(planId) {
    planToDelete = planId;

    const modal = document.getElementById('deleteModal');
    modal.classList.add('show');
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
    modal.style.opacity = '1';

    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.backgroundColor = 'white';
    modalContent.style.opacity = '1';
    modalContent.style.zIndex = '10001';
}

function closeDeleteModal() {
    planToDelete = null;
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('show');
    modal.style.display = 'none';
}

function confirmDelete() {
    if (!planToDelete) return;

    fetch('/echomind/api/plan/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            plan_id: planToDelete
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showFeedback('계획이 삭제되었습니다', 'success');
            closeDeleteModal();
            loadCalendar();
        } else {
            showFeedback('오류: ' + data.error, 'error');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showFeedback('삭제 실패', 'error');
    });
}

function showPlanDetails(plan) {
    const modal = document.getElementById('planDetailModal');
    const title = document.getElementById('planDetailTitle');
    const body = document.getElementById('planDetailBody');

    title.textContent = plan.category;

    let html = `
        <div style="margin-bottom: 15px;">
            <div style="color: #666; font-size: 12px; margin-bottom: 3px;">날짜</div>
            <div style="font-size: 15px;">${plan.date}</div>
        </div>
        <div style="margin-bottom: 15px;">
            <div style="color: #666; font-size: 12px; margin-bottom: 3px;">시간</div>
            <div style="font-size: 15px;">${plan.start_time} - ${plan.end_time}</div>
        </div>
    `;

    if (plan.note) {
        html += `
            <div style="margin-bottom: 15px;">
                <div style="color: #666; font-size: 12px; margin-bottom: 3px;">메모</div>
                <div style="font-size: 14px; white-space: pre-wrap;">${plan.note}</div>
            </div>
        `;
    }

    body.innerHTML = html;

    modal.classList.add('show');
    modal.style.display = 'flex';
    modal.style.zIndex = '10000';
    modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
    modal.style.opacity = '1';

    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.backgroundColor = 'white';
    modalContent.style.opacity = '1';
    modalContent.style.zIndex = '10001';
}

function closePlanDetailModal() {
    const modal = document.getElementById('planDetailModal');
    modal.classList.remove('show');
    modal.style.display = 'none';
}

function deletePlan(planId) {
    fetch('/echomind/api/plan/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            plan_id: planId
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showFeedback('계획이 삭제되었습니다', 'success');
            loadCalendar();
        } else {
            showFeedback('오류: ' + data.error, 'error');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showFeedback('삭제 실패', 'error');
    });
}

function setupLongPress(element, onLongPress, onClick) {
    let pressTimer = null;
    let isLongPress = false;
    let hasMoved = false;

    const startPress = (e) => {
        isLongPress = false;
        hasMoved = false;
        pressTimer = setTimeout(() => {
            if (!hasMoved) {
                isLongPress = true;
                // Visual feedback
                element.style.opacity = '0.5';
                // Small delay to show the visual feedback before deleting
                setTimeout(() => onLongPress(), 200);
            }
        }, 500); // 500ms long press
    };

    const cancelPress = () => {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }
        element.style.opacity = '1';
    };

    const handleClick = (e) => {
        cancelPress();
        if (!isLongPress && !hasMoved) {
            onClick();
        }
        isLongPress = false;
    };

    const handleMove = () => {
        hasMoved = true;
        cancelPress();
    };

    // Touch events for mobile
    element.addEventListener('touchstart', startPress, { passive: true });
    element.addEventListener('touchend', handleClick);
    element.addEventListener('touchmove', handleMove, { passive: true });
    element.addEventListener('touchcancel', cancelPress);

    // Mouse events for desktop
    element.addEventListener('mousedown', startPress);
    element.addEventListener('mouseup', handleClick);
    element.addEventListener('mousemove', handleMove);
    element.addEventListener('mouseleave', cancelPress);
}

function handleFormSubmit(e) {
    e.preventDefault();

    console.log('Form submit triggered');
    console.log('Selected category ID:', selectedCategoryId);

    if (!selectedCategoryId) {
        showFeedback('카테고리를 선택해주세요', 'error');
        return;
    }

    const planData = {
        date: document.getElementById('planDate').value,
        category_id: selectedCategoryId,
        start_time: document.getElementById('startTime').value,
        end_time: document.getElementById('endTime').value,
        note: document.getElementById('planNote').value
    };

    console.log('Sending plan data:', planData);

    fetch('/echomind/api/plan/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(planData)
    })
    .then(res => res.json())
    .then(data => {
        console.log('Server response:', data);
        if (data.success) {
            showFeedback('계획이 추가되었습니다', 'success');
            closeModal();
            loadCalendar();
        } else {
            showFeedback('오류: ' + data.error, 'error');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        showFeedback('저장 실패', 'error');
    });
}
{% endblock %}

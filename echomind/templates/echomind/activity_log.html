{% extends "echomind/base.html" %}

{% block title %}Echo Mind - Activity Log{% endblock %}

{% block extra_style %}
.category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}
.category-btn {
    padding: 15px 10px;
    font-size: 15px;
    border: 2px solid #ddd;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}
.category-btn:hover {
    background: #f0f0f0;
}
.category-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}
input[type="datetime-local"] {
    width: 100%;
    padding: 12px;
    line-height: 1.5;
    height: auto;
    display: block;
    box-sizing: border-box;
}
.tag-checkbox {
    display: inline-block;
    margin: 5px;
}
#activityTags .tag-checkbox {
    display: none;
}
.tag-checkbox label {
    padding: 8px 15px;
    border: 1px solid #ddd;
    border-radius: 20px;
    cursor: pointer;
    background: white;
    transition: all 0.2s;
}
.tag-checkbox input:checked + label {
    background: #28a745;
    color: white;
    border-color: #28a745;
}
.tag-checkbox input {
    display: none;
}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body">
        <form id="activityForm">
            <!-- Category Selection -->
            <label class="font-weight-bold">Category *</label>
            <div class="category-grid">
                {% for category in categories %}
                <button type="button" class="category-btn" data-category-id="{{ category.id }}">
                    {{ category.name }}
                </button>
                {% endfor %}
            </div>

            <!-- Time Inputs -->
            <div class="form-group">
                <label for="startTime" class="font-weight-bold">Start Time</label>
                <input type="datetime-local" class="form-control" id="startTime" required>
            </div>

            <div class="form-group">
                <label for="endTime" class="font-weight-bold">End Time</label>
                <input type="datetime-local" class="form-control" id="endTime" required>
            </div>

            <!-- Activity Tags -->
            <div class="form-group">
                <label class="font-weight-bold">Activity Tags (optional)</label>
                <div id="activityTags">
                    {% for tag in activity_tags %}
                    <div class="tag-checkbox" data-category-id="{{ tag.category.id|default:'' }}">
                        <input type="checkbox" id="actag{{ tag.id }}" value="{{ tag.id }}">
                        <label for="actag{{ tag.id }}">{{ tag.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Status Tags -->
            <div class="form-group">
                <label class="font-weight-bold">Status Tags (optional)</label>
                <div id="statusTags">
                    {% for tag in status_tags %}
                    <div class="tag-checkbox">
                        <input type="checkbox" id="stag{{ tag.id }}" value="{{ tag.id }}">
                        <label for="stag{{ tag.id }}">{{ tag.name }}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Description -->
            <div class="form-group">
                <label for="description" class="font-weight-bold">Description (optional)</label>
                <textarea class="form-control" id="description" rows="2" placeholder="Add notes..."></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-submit">Log Activity</button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_script %}
let selectedCategoryId = null;

// Load default times on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDefaultTimes();
});

// Category button selection
document.querySelectorAll('.category-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        selectedCategoryId = this.dataset.categoryId;

        // Filter activity tags based on selected category
        filterActivityTags(selectedCategoryId);
    });
});

// Function to filter activity tags by category
function filterActivityTags(categoryId) {
    const allTags = document.querySelectorAll('#activityTags .tag-checkbox');

    allTags.forEach(tag => {
        const tagCategoryId = tag.dataset.categoryId;

        // Show tag if it matches the selected category or has no category
        if (tagCategoryId === categoryId || tagCategoryId === '') {
            tag.style.display = 'inline-block';
        } else {
            tag.style.display = 'none';
            // Uncheck hidden tags
            const checkbox = tag.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
        }
    });
}

// Form submission
document.getElementById('activityForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!selectedCategoryId) {
        showFeedback('Please select a category', 'error');
        return;
    }

    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const description = document.getElementById('description').value;

    const selectedActivityTags = Array.from(document.querySelectorAll('#activityTags input:checked'))
        .map(checkbox => checkbox.value);

    const selectedStatusTags = Array.from(document.querySelectorAll('#statusTags input:checked'))
        .map(checkbox => checkbox.value);

    const data = {
        category_id: selectedCategoryId,
        start_time: startTime,
        end_time: endTime,
        description: description,
        activity_tags: selectedActivityTags,
        status_tags: selectedStatusTags
    };

    try {
        const response = await fetch('/echomind/api/activity/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showFeedback(`Activity logged! (${result.duration} min)`, 'success');
            resetForm();
            loadDefaultTimes();
        } else {
            showFeedback('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showFeedback('Network error', 'error');
    }
});

async function loadDefaultTimes() {
    try {
        const response = await fetch('/echomind/api/default-times/');
        const data = await response.json();

        document.getElementById('startTime').value = data.start_time;
        document.getElementById('endTime').value = data.end_time;
    } catch (error) {
        console.error('Failed to load default times', error);
    }
}

function resetForm() {
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
    selectedCategoryId = null;
    document.getElementById('description').value = '';
    document.querySelectorAll('#activityTags input:checked').forEach(cb => cb.checked = false);
    document.querySelectorAll('#statusTags input:checked').forEach(cb => cb.checked = false);

    // Hide all activity tags again
    document.querySelectorAll('#activityTags .tag-checkbox').forEach(tag => {
        tag.style.display = 'none';
    });
}
{% endblock %}

{% extends "echomind/base.html" %}

{% block title %}ÏùºÍ∞Ñ ÎπÑÍµê - Echo Mind{% endblock %}

{% block extra_style %}
/* Date Navigation */
.date-nav {
    background: white;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.date-nav-buttons {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
}

.date-nav button {
    background: linear-gradient(135deg, #C7CEEA 0%, #B5EAD7 100%);
    color: #333;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
    cursor: pointer;
}

.date-nav button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.date-label {
    font-weight: bold;
    font-size: 16px;
    color: #333;
}

/* Comparison Container */
.comparison-container {
    background: white;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 80px;
}

.comparison-grid {
    display: grid;
    grid-template-columns: 40px 1fr 1fr;
    gap: 5px;
}

/* Column Headers */
.column-header {
    padding: 10px;
    text-align: center;
    font-weight: bold;
    font-size: 14px;
    color: #333;
    background: #f8f9fa;
    border-radius: 6px;
}

.plan-header {
    background: linear-gradient(135deg, #E0BBE4 0%, #D5AAFF 100%);
    color: #333;
}

.activity-header {
    background: linear-gradient(135deg, #BAFFC9 0%, #BAE1FF 100%);
    color: #333;
}

/* Time Column */
.time-column {
    grid-column: 1;
    display: flex;
    flex-direction: column;
}

.time-label {
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: #666;
    border-bottom: 1px solid #eee;
}

/* Data Columns */
.data-column {
    position: relative;
    display: flex;
    flex-direction: column;
    border: 1px solid #eee;
    border-radius: 6px;
    overflow: visible;
}

.time-slot {
    height: 60px;
    border-bottom: 1px solid #f0f0f0;
    pointer-events: none;
}

.time-slot:last-child {
    border-bottom: none;
}

/* Plan/Activity Blocks */
.block {
    position: absolute !important;
    left: 2px;
    right: 2px;
    border-radius: 4px;
    padding: 4px;
    font-size: 11px;
    color: #333;
    overflow: hidden;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.1);
    transition: all 0.2s;
    font-weight: 500;
    z-index: 10;
}

.block:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    z-index: 20;
}

.block-category {
    font-weight: bold;
    font-size: 11px;
    margin-bottom: 2px;
}

.block-time {
    font-size: 9px;
    opacity: 0.8;
}

/* Lapse Stickers */
.lapse-stickers {
    position: absolute;
    top: 2px;
    right: 2px;
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
    max-width: 50px;
    justify-content: flex-end;
    z-index: 5;
}

.lapse-sticker {
    font-size: 12px;
    line-height: 1;
    filter: drop-shadow(0 1px 2px rgba(255,0,0,0.5));
}

/* Loading & Empty States */
.loading, .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state-icon {
    font-size: 48px;
    margin-bottom: 10px;
}

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-overlay.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 12px;
    padding: 20px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.modal-title {
    font-size: 18px;
    font-weight: bold;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #999;
    cursor: pointer;
}

.modal-section {
    margin-bottom: 15px;
}

.modal-label {
    font-weight: bold;
    color: #666;
    font-size: 12px;
    margin-bottom: 5px;
}

.modal-value {
    font-size: 15px;
    color: #333;
}
{% endblock %}

{% block content %}
<!-- Date Navigation -->
<div class="date-nav">
    <div class="date-nav-buttons">
        <button onclick="changeDate(-1)">‚Üê Ï†ÑÎÇ†</button>
        <span class="date-label" id="dateLabel">Loading...</span>
        <button onclick="changeDate(1)">Îã§ÏùåÎÇ† ‚Üí</button>
    </div>
</div>

<!-- Comparison Container -->
<div class="comparison-container" id="comparisonContainer">
    <div id="loadingIndicator" class="loading">
        Loading...
    </div>
    <div id="emptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üì≠</div>
        <div>Ïù¥ ÎÇ†ÏßúÏóê Í∏∞Î°ùÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>
    </div>
    <div class="comparison-grid" id="comparisonGrid" style="display: none;">
        <!-- Headers -->
        <div></div>
        <div class="column-header plan-header">Í≥ÑÌöç</div>
        <div class="column-header activity-header">Ïã§Ìñâ</div>

        <!-- Time labels -->
        <div class="time-column" id="timeColumn"></div>

        <!-- Plan column -->
        <div class="data-column" id="planColumn"></div>

        <!-- Activity column -->
        <div class="data-column" id="activityColumn"></div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="detailModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle"></div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<script>
let currentDate = new Date();

document.addEventListener('DOMContentLoaded', function() {
    loadData();
});

function changeDate(delta) {
    currentDate.setDate(currentDate.getDate() + delta);
    loadData();
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDateLabel(date) {
    const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const dayOfWeek = days[date.getDay()];
    return `${month}Ïõî ${day}Ïùº (${dayOfWeek})`;
}

function loadData() {
    const dateStr = formatDate(currentDate);
    document.getElementById('dateLabel').textContent = formatDateLabel(currentDate);

    const loading = document.getElementById('loadingIndicator');
    const empty = document.getElementById('emptyState');
    const grid = document.getElementById('comparisonGrid');

    loading.style.display = 'block';
    empty.style.display = 'none';
    grid.style.display = 'none';

    // Load both plans and activities
    Promise.all([
        fetch(`/echomind/api/plans/by-date/?date=${dateStr}`).then(r => r.json()),
        fetch(`/echomind/api/activities/by-date/?date=${dateStr}`).then(r => r.json())
    ])
    .then(([plansData, activitiesData]) => {
        loading.style.display = 'none';

        const plans = plansData.plans || [];
        const activities = activitiesData.activities || [];

        if (plans.length === 0 && activities.length === 0) {
            empty.style.display = 'block';
        } else {
            grid.style.display = 'grid';
            renderComparison(plans, activities);
        }
    })
    .catch(error => {
        console.error('Error loading data:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
    });
}

function renderComparison(plans, activities) {
    // Build time labels (6:00 - 24:00)
    const timeColumn = document.getElementById('timeColumn');
    timeColumn.innerHTML = '';

    for (let hour = 6; hour < 24; hour++) {
        const label = document.createElement('div');
        label.className = 'time-label';
        label.textContent = `${hour}:00`;
        timeColumn.appendChild(label);
    }

    // Build plan column
    const planColumn = document.getElementById('planColumn');
    planColumn.innerHTML = '';

    for (let hour = 6; hour < 24; hour++) {
        const slot = document.createElement('div');
        slot.className = 'time-slot';
        slot.dataset.hour = hour;
        planColumn.appendChild(slot);
    }

    // Render plans
    plans.forEach(plan => {
        renderPlanBlock(plan);
    });

    // Build activity column
    const activityColumn = document.getElementById('activityColumn');
    activityColumn.innerHTML = '';

    for (let hour = 6; hour < 24; hour++) {
        const slot = document.createElement('div');
        slot.className = 'time-slot';
        slot.dataset.hour = hour;
        activityColumn.appendChild(slot);
    }

    // Render activities
    activities.forEach(activity => {
        renderActivityBlock(activity);
    });
}

function renderPlanBlock(plan) {
    const startTime = plan.start_time.split(':');
    const endTime = plan.end_time.split(':');
    const startHour = parseInt(startTime[0]);
    const startMin = parseInt(startTime[1]);
    const endHour = parseInt(endTime[0]);
    const endMin = parseInt(endTime[1]);

    // Skip if outside visible hours
    if (endHour < 6 || startHour >= 24) return;

    // Calculate exact minutes from midnight
    const startTotalMinutes = startHour * 60 + startMin;
    const endTotalMinutes = endHour * 60 + endMin;

    // Clamp to visible hours (6:00 - 24:00)
    const visibleStartMinutes = Math.max(startTotalMinutes, 6 * 60);
    const visibleEndMinutes = Math.min(endTotalMinutes, 24 * 60);

    // Calculate position and height (1 minute = 1 pixel)
    const topOffset = visibleStartMinutes - (6 * 60); // Offset from 6:00
    const height = visibleEndMinutes - visibleStartMinutes;

    // Parse colors
    const colors = plan.color ? plan.color.split(',') : ['#E0BBE4', '#D5AAFF'];
    const gradient = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%)`;

    // Create block
    const block = document.createElement('div');
    block.className = 'block';
    block.style.top = `${topOffset}px`;
    block.style.height = `${Math.max(height, 20)}px`;
    block.style.background = gradient;

    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'block-category';
    categoryDiv.textContent = plan.category;

    const timeDiv = document.createElement('div');
    timeDiv.className = 'block-time';
    timeDiv.textContent = `${plan.start_time.substring(0, 5)}-${plan.end_time.substring(0, 5)}`;

    block.appendChild(categoryDiv);
    if (height > 30) {
        block.appendChild(timeDiv);
    }

    // Setup long press to delete
    setupLongPress(block, () => deletePlan(plan.id), () => showPlanDetail(plan));

    document.getElementById('planColumn').appendChild(block);
}

function renderActivityBlock(activity) {
    const startTime = new Date(activity.start_time);
    const endTime = new Date(activity.end_time);

    const startHour = startTime.getHours();
    const startMin = startTime.getMinutes();
    const endHour = endTime.getHours();
    const endMin = endTime.getMinutes();

    // Skip if outside visible hours
    if (endHour < 6 || startHour >= 24) {
        return;
    }

    // Calculate exact minutes from midnight
    const startTotalMinutes = startHour * 60 + startMin;
    const endTotalMinutes = endHour * 60 + endMin;

    // Clamp to visible hours (6:00 - 24:00)
    const visibleStartMinutes = Math.max(startTotalMinutes, 6 * 60);
    const visibleEndMinutes = Math.min(endTotalMinutes, 24 * 60);

    // Calculate position and height (1 minute = 1 pixel)
    const topOffset = visibleStartMinutes - (6 * 60); // Offset from 6:00
    const height = visibleEndMinutes - visibleStartMinutes;

    // Get category color from activity data
    const colors = activity.color ? activity.color.split(',') : ['#BAFFC9', '#BAE1FF'];
    const gradient = `linear-gradient(135deg, ${colors[0]} 0%, ${colors[1]} 100%)`;

    // Create block
    const block = document.createElement('div');
    block.className = 'block';
    block.style.top = `${topOffset}px`;
    block.style.height = `${Math.max(height, 20)}px`;
    block.style.background = gradient;

    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'block-category';
    categoryDiv.textContent = activity.category;

    const timeDiv = document.createElement('div');
    timeDiv.className = 'block-time';
    const startTimeStr = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')}`;
    const endTimeStr = `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`;
    timeDiv.textContent = `${startTimeStr}-${endTimeStr}`;

    block.appendChild(categoryDiv);
    if (height > 30) {
        block.appendChild(timeDiv);
    }

    // Add lapse stickers
    if (activity.lapses && activity.lapses.length > 0) {
        const stickersContainer = document.createElement('div');
        stickersContainer.className = 'lapse-stickers';
        stickersContainer.style.position = 'absolute';
        stickersContainer.style.top = '2px';
        stickersContainer.style.right = '2px';
        stickersContainer.style.display = 'flex';
        stickersContainer.style.gap = '3px';
        stickersContainer.style.flexWrap = 'wrap';
        stickersContainer.style.maxWidth = '60px';
        stickersContainer.style.justifyContent = 'flex-end';
        stickersContainer.style.zIndex = '15';

        activity.lapses.slice(0, 8).forEach((lapse, index) => {
            const sticker = document.createElement('div');
            sticker.className = 'lapse-sticker';
            sticker.textContent = '‚ö°';
            sticker.style.fontSize = '14px';
            sticker.style.lineHeight = '1';
            sticker.style.cursor = 'pointer';
            sticker.style.filter = 'drop-shadow(0 2px 3px rgba(255,0,0,0.6))';
            sticker.title = `${lapse.type} - ${lapse.category}${lapse.duration ? ` (${lapse.duration}Î∂Ñ)` : ''}`;
            stickersContainer.appendChild(sticker);
        });

        if (activity.lapses.length > 8) {
            const more = document.createElement('div');
            more.style.fontSize = '10px';
            more.style.fontWeight = 'bold';
            more.style.color = '#dc3545';
            more.style.backgroundColor = 'white';
            more.style.padding = '2px 3px';
            more.style.borderRadius = '3px';
            more.textContent = `+${activity.lapses.length - 8}`;
            stickersContainer.appendChild(more);
        }

        block.appendChild(stickersContainer);
    }

    // Setup long press to delete
    setupLongPress(block, () => deleteActivity(activity.id), () => showActivityDetail(activity));

    document.getElementById('activityColumn').appendChild(block);
}

function showPlanDetail(plan) {
    const modal = document.getElementById('detailModal');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');

    title.textContent = `Í≥ÑÌöç: ${plan.category}`;

    let html = `
        <div class="modal-section">
            <div class="modal-label">ÏãúÍ∞Ñ</div>
            <div class="modal-value">${plan.start_time.substring(0, 5)} - ${plan.end_time.substring(0, 5)}</div>
        </div>
    `;

    if (plan.estimated_hours) {
        html += `
            <div class="modal-section">
                <div class="modal-label">ÏòàÏÉÅ ÏãúÍ∞Ñ</div>
                <div class="modal-value">${plan.estimated_hours}ÏãúÍ∞Ñ</div>
            </div>
        `;
    }

    if (plan.note) {
        html += `
            <div class="modal-section">
                <div class="modal-label">Î©îÎ™®</div>
                <div class="modal-value">${plan.note}</div>
            </div>
        `;
    }

    body.innerHTML = html;
    modal.classList.add('show');
}

function showActivityDetail(activity) {
    const modal = document.getElementById('detailModal');
    const title = document.getElementById('modalTitle');
    const body = document.getElementById('modalBody');

    title.textContent = `Ïã§Ìñâ: ${activity.category}`;

    const startTime = new Date(activity.start_time);
    const endTime = new Date(activity.end_time);
    const startStr = `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
    const endStr = `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;

    let html = `
        <div class="modal-section">
            <div class="modal-label">ÏãúÍ∞Ñ</div>
            <div class="modal-value">${startStr} - ${endStr}</div>
        </div>
        <div class="modal-section">
            <div class="modal-label">ÏÜåÏöî ÏãúÍ∞Ñ</div>
            <div class="modal-value">ÏàúÏàò: ${activity.net_duration}Î∂Ñ / Ï¥ù: ${activity.duration}Î∂Ñ</div>
        </div>
    `;

    if (activity.description) {
        html += `
            <div class="modal-section">
                <div class="modal-label">ÏÑ§Î™Ö</div>
                <div class="modal-value">${activity.description}</div>
            </div>
        `;
    }

    if (activity.lapses && activity.lapses.length > 0) {
        html += `
            <div class="modal-section">
                <div class="modal-label">Ï£ºÏùòÎ†• Ïù¥ÌÉà (${activity.lapses.length}Í±¥)</div>
        `;
        activity.lapses.forEach(lapse => {
            html += `
                <div style="background: #fff3cd; padding: 8px; margin-top: 5px; border-radius: 4px; border-left: 3px solid #dc3545;">
                    <div style="font-weight: bold; color: #dc3545; font-size: 12px;">${lapse.type} - ${lapse.category}</div>
                    <div style="font-size: 11px;">${lapse.timestamp}${lapse.duration ? ` (${lapse.duration}Î∂Ñ)` : ''}</div>
                    ${lapse.description ? `<div style="font-size: 11px; margin-top: 3px;">${lapse.description}</div>` : ''}
                </div>
            `;
        });
        html += `</div>`;
    }

    body.innerHTML = html;
    modal.classList.add('show');
}

function closeModal() {
    document.getElementById('detailModal').classList.remove('show');
}

function setupLongPress(element, onLongPress, onClick) {
    let pressTimer = null;
    let isLongPress = false;
    let hasMoved = false;

    const startPress = (e) => {
        isLongPress = false;
        hasMoved = false;
        pressTimer = setTimeout(() => {
            if (!hasMoved) {
                isLongPress = true;
                // Visual feedback
                element.style.opacity = '0.5';
                // Small delay to show the visual feedback before deleting
                setTimeout(() => onLongPress(), 200);
            }
        }, 500); // 500ms long press
    };

    const cancelPress = () => {
        if (pressTimer) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }
        element.style.opacity = '1';
    };

    const handleClick = (e) => {
        cancelPress();
        if (!isLongPress && !hasMoved) {
            onClick();
        }
        isLongPress = false;
    };

    const handleMove = () => {
        hasMoved = true;
        cancelPress();
    };

    // Touch events for mobile
    element.addEventListener('touchstart', startPress, { passive: true });
    element.addEventListener('touchend', handleClick);
    element.addEventListener('touchmove', handleMove, { passive: true });
    element.addEventListener('touchcancel', cancelPress);

    // Mouse events for desktop
    element.addEventListener('mousedown', startPress);
    element.addEventListener('mouseup', handleClick);
    element.addEventListener('mousemove', handleMove);
    element.addEventListener('mouseleave', cancelPress);
}

function deletePlan(planId) {
    fetch('/echomind/api/plan/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ plan_id: planId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            loadData(); // Reload the data
        } else {
            console.error('ÏÇ≠Ï†ú Ïã§Ìå®:', data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting plan:', error);
    });
}

function deleteActivity(activityId) {
    fetch('/echomind/api/activity/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ activity_id: activityId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeModal();
            loadData(); // Reload the data
        } else {
            console.error('ÏÇ≠Ï†ú Ïã§Ìå®:', data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting activity:', error);
    });
}

// Close modal on backdrop click
document.getElementById('detailModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}

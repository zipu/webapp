{% extends "trading/base_trading.html"%}
{% load humanize %}
{% load static %}
{% block content2 %}

<!-- ìµœëŒ€ ë„ˆë¹„ ì œí•œ ì»¨í…Œì´ë„ˆ -->
<div class="note-container">

<style>
/* ì»¨í…Œì´ë„ˆ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
.note-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
}

@media (max-width: 1300px) {
    .note-container {
        max-width: 95%;
    }
}

@media (max-width: 768px) {
    .note-container {
        max-width: 100%;
        padding: 0 10px;
    }
}
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.create-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

/* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
.table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 0;
}

.table thead th {
    background-color: #f8f9fa !important;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
}

.table td {
    vertical-align: middle;
}

/* ì œëª© ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ */
.table td:nth-child(2) {
    max-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* ë…¸íŠ¸ í–‰ ìŠ¤íƒ€ì¼ */
.note-row {
    transition: background-color 0.2s ease;
}

.note-row:hover {
    background-color: #f8f9fa;
}

.note-title {
    transition: color 0.2s ease;
}

.note-title:hover {
    color: #0d6efd;
}

.toggle-icon {
    transition: transform 0.3s ease;
    font-size: 0.8rem;
}

.toggle-icon.rotated {
    transform: rotate(180deg);
}

/* íƒœê·¸ ìŠ¤íƒ€ì¼ */
.tag-badge {
    background-color: #e3f2fd;
    color: #1976d2;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-right: 4px;
    margin-bottom: 2px;
    display: inline-block;
    font-weight: 500;
}

/* ë‚´ìš© í–‰ ìŠ¤íƒ€ì¼ */
.content-row {
    background-color: #f8f9fa;
}

.note-content-wrapper {
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin: 10px;
    border-left: 4px solid #0d6efd;
}

.note-content {
    line-height: 1.6;
    color: #333;
}

.note-content h1, .note-content h2, .note-content h3 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.note-content p {
    margin-bottom: 1rem;
}

/* íŒŒì¼ ëª©ë¡ ìŠ¤íƒ€ì¼ */
.file-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.file-item {
    background: #e9ecef;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.85rem;
}

.file-item a {
    color: #495057;
    text-decoration: none;
}

.file-item a:hover {
    color: #0d6efd;
}

/* ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* ë°˜ì‘í˜• */
@media (max-width: 768px) {
    .table th, .table td {
        padding: 0.5rem 0.25rem;
        font-size: 0.85rem;
    }
    
    .tag-badge {
        font-size: 0.7rem;
        padding: 1px 6px;
    }
    
    .note-content-wrapper {
        padding: 15px;
        margin: 5px;
    }
}

/* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ ê°œì„  */
.pagination {
    margin-top: 2rem;
}

.page-link {
    color: #6c757d;
    border-color: #dee2e6;
}

.page-link:hover {
    color: #0d6efd;
    background-color: #e9ecef;
    border-color: #dee2e6;
}

.page-item.active .page-link {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* Pell Editor í…ìŠ¤íŠ¸ ì™¼ìª½ ì •ë ¬ */
.pell-content {
    text-align: left !important;
}

.pell-content p, .pell-content div, .pell-content h1, .pell-content h2,
.pell-content h3, .pell-content h4, .pell-content h5, .pell-content h6,
.pell-content ol, .pell-content ul, .pell-content li {
    text-align: left !important;
}

/* ë…¸íŠ¸ ë‚´ìš©ë„ ì™¼ìª½ ì •ë ¬ */
.note-content {
    text-align: left !important;
}

.note-content p, .note-content div, .note-content h1, .note-content h2,
.note-content h3, .note-content h4, .note-content h5, .note-content h6,
.note-content ol, .note-content ul, .note-content li {
    text-align: left !important;
}
</style>

<!-- ë…¸íŠ¸ ì‘ì„± ì„¹ì…˜ -->
<div class="create-section" id="createSection" style="display:none;">
    <h5>ğŸ“ ìƒˆ ë…¸íŠ¸ ì‘ì„±</h5>
    <form action="{% url 'note' page='1' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="mb-3">
            <label class="form-label">ì œëª©</label>
            <input type="text" name="title" class="form-control" required>
        </div>
        
        <div class="mb-3">
            <label class="form-label">ë‚´ìš©</label>
            <div id="editor"></div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">íƒœê·¸</label>
                <input type="text" name="tags" class="form-control" placeholder="íƒœê·¸1;íƒœê·¸2;íƒœê·¸3">
                <small class="text-muted">ì„¸ë¯¸ì½œë¡ (;)ìœ¼ë¡œ êµ¬ë¶„</small>
            </div>
            <div class="col-md-6">
                <label class="form-label">íŒŒì¼ ì²¨ë¶€</label>
                <input type="file" name="file" class="form-control" multiple>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
            <button type="button" class="btn btn-secondary" onclick="toggleCreate()">âŒ ì·¨ì†Œ</button>
        </div>
    </form>
</div>

<!-- ë…¸íŠ¸ ëª©ë¡ -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>ğŸ“‹ ë…¸íŠ¸ ëª©ë¡ <small class="text-muted">({{ notes|length }}ê°œ)</small></h4>
    <button class="btn btn-success" onclick="toggleCreate()">
        â• ìƒˆ ë…¸íŠ¸ ì‘ì„±
    </button>
</div>

{% if notes %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-light">
            <tr>
                <th width="12%">ğŸ“… ë‚ ì§œ</th>
                <th width="40%">ğŸ“ ì œëª©</th>
                <th width="25%">ğŸ·ï¸ íƒœê·¸</th>
                <th width="13%">ğŸ“ íŒŒì¼</th>
                <th width="10%">ì‘ì—…</th>
            </tr>
        </thead>
        <tbody>
            {% for note in notes %}
            <tr class="note-row" data-note-id="{{ note.id }}">
                <td class="text-muted">
                    <small>{{ note.date|date:"m-d H:i" }}</small>
                </td>
                <td>
                    <div class="note-title" onclick="toggleContent({{ note.id }})" style="cursor: pointer;" title="{{ note.title }}">
                        <strong>{{ note.title }}</strong>
                        <i class="fas fa-chevron-down ms-1 toggle-icon" id="icon-{{ note.id }}"></i>
                    </div>
                </td>
                <td>
                    {% if note.tags.all %}
                        {% for tag in note.tags.all %}
                        <span class="tag-badge">{{ tag.name }}</span>
                        {% endfor %}
                    {% else %}
                        <small class="text-muted">-</small>
                    {% endif %}
                </td>
                <td>
                    {% if note.files.all %}
                        <span class="badge bg-info">{{ note.files.all|length }}ê°œ</span>
                    {% else %}
                        <small class="text-muted">-</small>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="toggleContent({{ note.id }})" title="ë‚´ìš© ë³´ê¸°">
                            <i class="fas fa-eye"></i>
                        </button>
                        <a href="?id={{ note.id }}" class="btn btn-outline-danger btn-sm" 
                           onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" title="ì‚­ì œ">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            <!-- ë…¸íŠ¸ ë‚´ìš© í–‰ (í† ê¸€) -->
            <tr id="content-row-{{ note.id }}" class="content-row" style="display:none;">
                <td colspan="5">
                    <div class="note-content-wrapper">
                        <div class="note-content">
                            {{ note.memo|safe }}
                        </div>
                        
                        {% if note.files.all %}
                        <div class="mt-3 pt-3 border-top">
                            <h6>ğŸ“ ì²¨ë¶€íŒŒì¼</h6>
                            <div class="file-list">
                                {% for file in note.files.all %}
                                <div class="file-item">
                                    <a href="{{ file.file.url }}" download class="text-decoration-none">
                                        <i class="fas fa-download"></i> {{ file.name }}
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-sticky-note fa-3x text-muted mb-3"></i>
    <h5 class="text-muted">ğŸ“ ì•„ì§ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
    <p class="text-muted">ì²« ë²ˆì§¸ ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
</div>
{% endif %}

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if is_paginated %}
<nav aria-label="í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=1 %}">âª</a>
        </li>
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=page_obj.previous %}">â¬…ï¸</a>
        </li>
        {% for page in page_obj.rng %}
            {% if page_obj.page == page %}
                <li class="page-item active">
                    <a class="page-link" href="#">{{ page }}</a>
                </li>
            {% else %}
                <li class="page-item">
                    <a class="page-link" href="{% url 'note' page=page %}">{{ page }}</a>
                </li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=page_obj.next %}">â¡ï¸</a>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=page_obj.num_page %}">â©</a>
        </li>
    </ul>
</nav>
{% endif %}

{% endblock content2 %}

{% block script %}
<!-- í…ìŠ¤íŠ¸ ì—ë””í„° -->
<link rel="stylesheet" href="{% static 'css/pell.min.css' %}">
<script src="{% static 'js/pell.min.js' %}"></script>
<script>
pell.init({
    element: document.getElementById('editor'),
    actions: ['bold', 'italic', 'heading1', 'heading2', 'olist', 'ulist', 'image'],
    onChange: html => {
    }
});

$( "form" ).submit(function( event ) {
  var input = $("<input>")
               .attr("type", "hidden")
               .attr("name", "memo").val($('.pell-content').html());
  $('form').append(input);
});

// ë…¸íŠ¸ ì‘ì„± ì„¹ì…˜ í† ê¸€
function toggleCreate() {
    const section = document.getElementById('createSection');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
    } else {
        section.style.display = 'none';
    }
}

// ë…¸íŠ¸ ë‚´ìš© í† ê¸€ (ê°œì„ ëœ ë²„ì „)
function toggleContent(noteId) {
    const contentRow = document.getElementById('content-row-' + noteId);
    const icon = document.getElementById('icon-' + noteId);
    
    if (contentRow.style.display === 'none') {
        contentRow.style.display = 'table-row';
        icon.classList.add('rotated');
    } else {
        contentRow.style.display = 'none';
        icon.classList.remove('rotated');
    }
}

// í…ìŠ¤íŠ¸ ì—ë””í„° ë
</script>

</div> <!-- note-container ë -->
{% endblock script %}
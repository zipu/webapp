{% extends "trading/base_trading.html"%}
{% load humanize %}
{% load static %}
{% block content2 %}

<style>
.note-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 15px;
    background: white;
}
.note-meta {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 10px;
}
.tag-badge {
    background-color: #e9ecef;
    color: #495057;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    margin-right: 5px;
}
.create-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}
</style>

<!-- ë…¸íŠ¸ ì‘ì„± ì„¹ì…˜ -->
<div class="create-section" id="createSection" style="display:none;">
    <h5>ğŸ“ ìƒˆ ë…¸íŠ¸ ì‘ì„±</h5>
    <form action="{% url 'note' page='1' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="mb-3">
            <label class="form-label">ì œëª©</label>
            <input type="text" name="title" class="form-control" required>
        </div>
        
        <div class="mb-3">
            <label class="form-label">ë‚´ìš©</label>
            <textarea name="memo" id="editor" rows="10" class="form-control"></textarea>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label class="form-label">íƒœê·¸</label>
                <input type="text" name="tags" class="form-control" placeholder="íƒœê·¸1;íƒœê·¸2;íƒœê·¸3">
                <small class="text-muted">ì„¸ë¯¸ì½œë¡ (;)ìœ¼ë¡œ êµ¬ë¶„</small>
            </div>
            <div class="col-md-6">
                <label class="form-label">íŒŒì¼ ì²¨ë¶€</label>
                <input type="file" name="file" class="form-control" multiple>
            </div>
        </div>
        
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">ğŸ’¾ ì €ì¥</button>
            <button type="button" class="btn btn-secondary" onclick="toggleCreate()">âŒ ì·¨ì†Œ</button>
        </div>
    </form>
</div>

<!-- ë…¸íŠ¸ ëª©ë¡ -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4>ğŸ“‹ ë…¸íŠ¸ ëª©ë¡</h4>
    <button class="btn btn-success" onclick="toggleCreate()">
        â• ìƒˆ ë…¸íŠ¸ ì‘ì„±
    </button>
</div>

{% for note in notes %}
<div class="note-card">
    <div class="note-meta">
        ğŸ“… {{ note.date|date:"Y-m-d H:i" }}
        {% if note.tags.all %}
        | ğŸ·ï¸ {% for tag in note.tags.all %}<span class="tag-badge">{{ tag.name }}</span>{% endfor %}
        {% endif %}
    </div>
    
    <h6>{{ note.title }}</h6>
    
    <div id="content-{{ note.id }}" style="display:none;">
        <div class="mt-2 p-2 border-top">
            {{ note.memo|safe }}
        </div>
        
        {% if note.files.all %}
        <div class="mt-2">
            <strong>ğŸ“ ì²¨ë¶€íŒŒì¼:</strong>
            {% for file in note.files.all %}
            <div><a href="{{ file.file.url }}" download>ğŸ“„ {{ file.name }}</a></div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <div class="mt-2">
        <button class="btn btn-sm btn-outline-primary" onclick="toggleContent({{ note.id }})">
            ğŸ‘ï¸ ë‚´ìš© ë³´ê¸°
        </button>
        <a href="?id={{ note.id }}" class="btn btn-sm btn-outline-danger" 
           onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
            ğŸ—‘ï¸ ì‚­ì œ
        </a>
    </div>
</div>
{% empty %}
<div class="text-center py-5">
    <h5 class="text-muted">ğŸ“ ì•„ì§ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
    <p class="text-muted">ì²« ë²ˆì§¸ ë…¸íŠ¸ë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
</div>
{% endfor %}

<!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
{% if is_paginated %}
<nav aria-label="í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=1 %}">âª</a>
        </li>
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=page_obj.previous %}">â¬…ï¸</a>
        </li>
        {% for page in page_obj.rng %}
            {% if page_obj.page == page %}
                <li class="page-item active">
                    <a class="page-link" href="#">{{ page }}</a>
                </li>
            {% else %}
                <li class="page-item">
                    <a class="page-link" href="{% url 'note' page=page %}">{{ page }}</a>
                </li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=page_obj.next %}">â¡ï¸</a>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
            <a class="page-link" href="{% url 'note' page=page_obj.num_page %}">â©</a>
        </li>
    </ul>
</nav>
{% endif %}

{% endblock content2 %}

{% block script %}
<!-- CKEditor 5 CDN -->
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

<script>
// CKEditor ì´ˆê¸°í™” (ê°„ë‹¨í•œ ì„¤ì •)
let editor;
ClassicEditor
    .create(document.querySelector('#editor'), {
        toolbar: [
            'heading', '|',
            'bold', 'italic', '|',
            'bulletedList', 'numberedList', '|',
            'link', 'blockQuote'
        ],
        language: 'ko'
    })
    .then(newEditor => {
        editor = newEditor;
    })
    .catch(error => {
        console.error('Editor error:', error);
    });

// ë…¸íŠ¸ ì‘ì„± ì„¹ì…˜ í† ê¸€
function toggleCreate() {
    const section = document.getElementById('createSection');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
    } else {
        section.style.display = 'none';
    }
}

// ë…¸íŠ¸ ë‚´ìš© í† ê¸€
function toggleContent(noteId) {
    const content = document.getElementById('content-' + noteId);
    if (content.style.display === 'none') {
        content.style.display = 'block';
    } else {
        content.style.display = 'none';
    }
}

// í¼ ì œì¶œ ì‹œ ì—ë””í„° ë‚´ìš© ì„¤ì •
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (editor) {
                document.querySelector('#editor').value = editor.getData();
            }
        });
    }
});
</script>
{% endblock script %}
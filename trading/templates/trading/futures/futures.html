{% extends "trading/futures/base.html" %}
{% load humanize %}

{% block content %}
<div class="container-mobile">
  <!-- ê¸°ê°„ ì„ íƒ íƒ­ -->
  <div style="display: flex; gap: 8px; margin-bottom: 12px; background: #f5f5f5; padding: 4px; border-radius: 8px;">
    <button class="period-btn active" data-period="month" style="flex: 1; padding: 8px; border: none; border-radius: 6px; background: #fff; font-weight: 600; cursor: pointer; transition: all 0.3s;">ìµœê·¼ í•œ ë‹¬</button>
    <button class="period-btn" data-period="year" style="flex: 1; padding: 8px; border: none; border-radius: 6px; background: transparent; font-weight: 600; cursor: pointer; transition: all 0.3s;">ìµœê·¼ 1ë…„</button>
    <button class="period-btn" data-period="all" style="flex: 1; padding: 8px; border: none; border-radius: 6px; background: transparent; font-weight: 600; cursor: pointer; transition: all 0.3s;">ì „ì²´</button>
  </div>

  <!-- ìš”ì•½ ì¹´ë“œ -->
  <div class="summary-card">
    <h3 id="period-title">ìµœê·¼ í•œ ë‹¬</h3>
    <div class="profit-big" id="week-profit">ë¡œë”© ì¤‘...</div>
    <div class="stats-row">
      <span id="win-rate">ìŠ¹ë¥ : -</span>
      <span id="pnl-ratio">ì†ìµë¹„: -</span>
    </div>
  </div>

  <!-- ëª©í‘œ í”„ë¡œê·¸ë ˆìŠ¤ (ë‚˜ì¤‘ì— ì¶”ê°€) -->
  <!-- <div class="goal-card">
    <h3>ğŸ¯ ì£¼ê°„ ëª©í‘œ</h3>
    <div class="progress">
      <div class="progress-bar" id="goal-progress" style="width: 0%"></div>
    </div>
    <span id="goal-text">$0 / $0 (0%)</span>
  </div> -->

  <!-- UserGoal ê¸°ë°˜ ì•Œë¦¼ -->
  {% if goal_alerts %}
  <div id="goal-alerts-container">
    {% for alert in goal_alerts %}
    <div class="alert-card {% if alert.level == 'high' %}high{% else %}medium{% endif %}" style="margin-bottom: 12px;">
      <strong>{% if alert.level == 'high' %}ğŸš¨ ê¸´ê¸‰{% else %}âš ï¸ ì£¼ì˜{% endif %}</strong>
      <p style="margin: 8px 0 0 0;">{{ alert.message }}</p>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ì•Œë¦¼ ì»¨í…Œì´ë„ˆ (ê¸°ì¡´ ì°¨íŠ¸ ê¸°ë°˜) -->
  <div id="alerts-container"></div>

  <!-- ìˆ˜ìµ ê³¡ì„  -->
  <div class="chart-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <h3 style="margin: 0;">ğŸ“ˆ ìˆ˜ìµ ê³¡ì„  <span style="font-size: 12px; color: #757575; font-weight: normal;">(ë‹¨ìœ„: ë§Œì›)</span></h3>
      <select id="chart-type-selector" style="padding: 6px 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 13px; background: #fff; cursor: pointer;">
        <option value="net">ìˆœìˆ˜ìµ (ìˆ˜ìˆ˜ë£Œ í¬í•¨)</option>
        <option value="gross">ì´ìˆ˜ìµ (ìˆ˜ìˆ˜ë£Œ ë¯¸í¬í•¨)</option>
        <option value="commission">ëˆ„ì  ìˆ˜ìˆ˜ë£Œ</option>
      </select>
    </div>
    <div id="profit-chart"></div>
  </div>

  <!-- í•µì‹¬ ì§€í‘œ -->
  <div style="margin-bottom: 16px;" id="key-metrics-container">
    <!-- JavaScriptë¡œ ë™ì  ë¡œë“œ -->
  </div>
</div>
{% endblock %}

{% block script %}
<script>
// Lightweight Charts ì´ˆê¸°í™”
let chart = null;
let lineSeries = null;
let currentChartData = null; // ì°¨íŠ¸ ë°ì´í„° ì €ì¥
let currentChartType = 'net'; // í˜„ì¬ ì°¨íŠ¸ íƒ€ì…

try {
    if (typeof LightweightCharts === 'undefined') {
        throw new Error('LightweightCharts library not loaded');
    }

    const chartContainer = document.getElementById('profit-chart');
    chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.offsetWidth,
        height: 300,
        layout: {
            textColor: '#333',
            background: { color: '#fff' }
        },
        grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' }
        },
        timeScale: {
            timeVisible: true,
            secondsVisible: false,
        },
        rightPriceScale: {
            borderVisible: false,
        },
        localization: {
            priceFormatter: function(price) {
                return Math.round(price).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
        }
    });

    lineSeries = chart.addLineSeries({
        color: '#2962FF',
        lineWidth: 2
    });
} catch (error) {
    console.error('Chart initialization error:', error);
    document.getElementById('profit-chart').innerHTML = '<p style="color: red; padding: 20px;">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ' + error.message + '</p>';
}

// ì°¨íŠ¸ íƒ€ì… ì„ íƒê¸° ì´ë²¤íŠ¸
document.getElementById('chart-type-selector').addEventListener('change', function() {
    currentChartType = this.value;
    if (currentChartData) {
        updateChart(currentChartData, currentChartType);
    }
});

// ì°¨íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateChart(chartData, chartType) {
    if (!lineSeries || !chart) return;

    const processedData = [];
    let cumulative = 0;

    if (chartData && chartData.length > 0) {
        for (let item of chartData) {
            const profit = item[1];      // day_profit
            const commission = item[2];  // day_commission

            // ì°¨íŠ¸ íƒ€ì…ì— ë”°ë¼ ëˆ„ì ê°’ ê³„ì‚°
            if (chartType === 'net') {
                // ìˆœìˆ˜ìµ (ìˆ˜ìˆ˜ë£Œ í¬í•¨)
                cumulative += profit - commission;
                lineSeries.applyOptions({ color: '#2962FF' });
            } else if (chartType === 'gross') {
                // ì´ìˆ˜ìµ (ìˆ˜ìˆ˜ë£Œ ë¯¸í¬í•¨)
                cumulative += profit;
                lineSeries.applyOptions({ color: '#4CAF50' });
            } else if (chartType === 'commission') {
                // ëˆ„ì  ìˆ˜ìˆ˜ë£Œ
                cumulative += commission;
                lineSeries.applyOptions({ color: '#ff9800' });
            }

            processedData.push({
                time: item[0],
                value: cumulative / 10000  // ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜
            });
        }

        // ë§ˆì§€ë§‰ ë°ì´í„° ë‚ ì§œê°€ ì˜¤ëŠ˜ì´ ì•„ë‹ˆë©´, ì˜¤ëŠ˜ ë‚ ì§œ ì¶”ê°€ (ê°™ì€ ëˆ„ì ê°’)
        const lastDate = processedData[processedData.length - 1].time;
        const todayStr = new Date().toISOString().split('T')[0];
        if (lastDate !== todayStr) {
            processedData.push({
                time: todayStr,
                value: cumulative / 10000
            });
        }

        lineSeries.setData(processedData);
        chart.timeScale().fitContent();
    } else {
        // ë°ì´í„° ì—†ì„ ë•Œ ì´ˆê¸°ê°’
        lineSeries.setData([{
            time: new Date().toISOString().split('T')[0],
            value: 0
        }]);
        chart.timeScale().fitContent();
    }
}

// ê¸°ê°„ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
let currentPeriod = 'month';
document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        currentPeriod = this.getAttribute('data-period');

        // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
        document.querySelectorAll('.period-btn').forEach(b => {
            b.classList.remove('active');
            b.style.background = 'transparent';
        });
        this.classList.add('active');
        this.style.background = '#fff';

        // íƒ€ì´í‹€ ë³€ê²½
        const titles = {
            'month': 'ìµœê·¼ í•œ ë‹¬',
            'year': 'ìµœê·¼ 1ë…„',
            'all': 'ì „ì²´'
        };
        document.getElementById('period-title').textContent = titles[currentPeriod];

        // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        loadHomeData(currentPeriod);
    });
});

// ë°ì´í„° ë¡œë“œ
loadHomeData('month');

function loadHomeData(period) {
    const today = new Date();
    let startDate;

    if (period === 'month') {
        startDate = new Date(today);
        startDate.setDate(today.getDate() - 30);
    } else if (period === 'year') {
        startDate = new Date(today);
        startDate.setFullYear(today.getFullYear() - 1);
    } else { // 'all'
        startDate = new Date('1900-01-01'); // ì „ì²´ ê¸°ê°„
    }

    $.ajax({
        url: "{% url 'statdata' %}",
        type: "get",
        data: {
            start: startDate.toISOString().split('T')[0],
            end: today.toISOString().split('T')[0],
            period: period
        },
        success: function(data) {
            // ìš”ì•½ ì—…ë°ì´íŠ¸
            const profit = data.profit || 0;
            document.getElementById('week-profit').textContent =
                (profit >= 0 ? 'â‚©' : '-â‚©') + Math.abs(profit).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            document.getElementById('week-profit').className =
                profit >= 0 ? 'profit-big' : 'profit-big negative';

            document.getElementById('win-rate').textContent =
                `ìŠ¹ë¥ : ${(data.win_rate || 0).toFixed(0)}%`;
            document.getElementById('pnl-ratio').textContent =
                `ì†ìµë¹„: ${(data.pnl || 0).toFixed(1)}:1`;

            // ì°¨íŠ¸ ë°ì´í„° ì €ì¥ ë° ì—…ë°ì´íŠ¸
            if (lineSeries && chart) {
                currentChartData = data.chart_data;
                updateChart(currentChartData, currentChartType);
            }

            // key_metrics ì—…ë°ì´íŠ¸
            if (data.key_metrics) {
                updateKeyMetrics(data.key_metrics);
            }

            // ì•Œë¦¼ ìƒì„± (ê¸°ê°„ ì •ë³´ í¬í•¨)
            generateAlerts(data, period);
        },
        error: function(xhr, status, error) {
            console.error('Error loading data:', error, xhr.responseText);
            document.getElementById('week-profit').textContent = 'Error: ' + status;
            document.getElementById('week-profit').className = 'profit-big negative';
            alert('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ' + status + '\n' + (xhr.responseText || error));
        }
    });
}

function updateKeyMetrics(metrics) {
    const container = document.getElementById('key-metrics-container');
    if (!container) return;

    const formatNumber = (num) => {
        return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };

    container.innerHTML = `
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ì´ ê±°ë˜</div>
        <div style="font-size: 24px; font-weight: bold; color: #333;">${metrics.total_trades}íšŒ</div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ìŠ¹ë¥ </div>
        <div style="font-size: 24px; font-weight: bold; color: ${metrics.win_rate >= 50 ? '#4CAF50' : '#ff9800'};">${metrics.win_rate.toFixed(0)}%</div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ìˆœìˆ˜ìµ</div>
        <div style="font-size: 20px; font-weight: bold; color: ${metrics.net_profit >= 0 ? '#d32f2f' : '#1976d2'};">
          ${metrics.net_profit >= 0 ? 'â‚©' : '-â‚©'}${formatNumber(Math.abs(metrics.net_profit))}
        </div>
        <div style="font-size: 11px; color: #9e9e9e; margin-top: 4px;">ì¼í‰ê·  ${metrics.day_avg_profit >= 0 ? 'â‚©' : '-â‚©'}${formatNumber(Math.abs(metrics.day_avg_profit))}</div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">í‰ê·  ìˆ˜ìµ</div>
        <div style="font-size: 20px; font-weight: bold; color: ${metrics.avg_profit >= 0 ? '#d32f2f' : '#1976d2'};">
          ${metrics.avg_profit >= 0 ? 'â‚©' : '-â‚©'}${formatNumber(Math.abs(metrics.avg_profit))}
        </div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ì†ìµë¹„</div>
        <div style="font-size: 24px; font-weight: bold; color: #2962FF;">${metrics.pnl_ratio.toFixed(1)}:1</div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">Optimal F</div>
        <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">${metrics.optimal_f.toFixed(1)}%</div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ìµœê³  ìˆ˜ìµ</div>
        <div style="font-size: 18px; font-weight: bold; color: #d32f2f;">â‚©${formatNumber(metrics.best_trade)}</div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ìµœëŒ€ ì†ì‹¤</div>
        <div style="font-size: 18px; font-weight: bold; color: #1976d2;">-â‚©${formatNumber(Math.abs(metrics.worst_trade))}</div>
      </div>
    </div>
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ê¸°ëŒ€ê°’</div>
        <div style="font-size: 22px; font-weight: bold; color: ${metrics.expectancy >= 0 ? '#d32f2f' : '#1976d2'};">
          ${metrics.expectancy >= 0 ? 'â‚©' : '-â‚©'}${formatNumber(Math.abs(metrics.expectancy))}
        </div>
        <div style="font-size: 11px; color: #9e9e9e; margin-top: 4px;">ê±°ë˜ë‹¹ í‰ê·  ê¸°ëŒ€ìˆ˜ìµ</div>
      </div>
      <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ìƒ¤í”„ ë¹„ìœ¨</div>
        <div style="font-size: 22px; font-weight: bold; color: ${metrics.sharpe_ratio >= 1 ? '#d32f2f' : metrics.sharpe_ratio >= 0 ? '#ff9800' : '#1976d2'};">
          ${metrics.sharpe_ratio.toFixed(2)}
        </div>
        <div style="font-size: 11px; color: #9e9e9e; margin-top: 4px;">ë¦¬ìŠ¤í¬ ëŒ€ë¹„ ìˆ˜ìµë¥ </div>
      </div>
    </div>
    `;
}

function generateAlerts(data, period) {
    const alerts = [];

    // ê¸°ê°„ í…ìŠ¤íŠ¸ ë§¤í•‘
    const periodText = {
        'month': 'ìµœê·¼ í•œ ë‹¬',
        'year': 'ìµœê·¼ 1ë…„',
        'all': 'ì „ì²´ ê¸°ê°„'
    };
    const periodStr = periodText[period] || 'í•´ë‹¹ ê¸°ê°„';

    // ìŠ¹ë¥  ì²´í¬
    if (data.win_rate && data.win_rate < 40 && data.num_trades > 5) {
        alerts.push({
            message: `${periodStr} ë™ì•ˆ ìŠ¹ë¥ ì´ ë‚®ìŠµë‹ˆë‹¤ (${data.win_rate.toFixed(1)}%, 40% ë¯¸ë§Œ)`,
            severity: 'high'
        });
    }

    // ì†ìµë¹„ ì²´í¬
    if (data.pnl && data.pnl < 1 && data.num_trades > 5) {
        alerts.push({
            message: `${periodStr} ë™ì•ˆ ì†ìµë¹„ê°€ 1:1 ë¯¸ë§Œì…ë‹ˆë‹¤ (${data.pnl.toFixed(2)}:1)`,
            severity: 'medium'
        });
    }

    // ì†ì‹¤ ì²´í¬
    if (data.profit < 0) {
        alerts.push({
            message: `${periodStr} ë™ì•ˆ ì†ì‹¤ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (â‚©${Math.abs(data.profit).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')})`,
            severity: 'high'
        });
    }

    // ê±°ë˜ íšŸìˆ˜ê°€ ë„ˆë¬´ ì ì„ ë•Œ
    if (data.num_trades < 3 && period === 'month') {
        alerts.push({
            message: `${periodStr} ë™ì•ˆ ê±°ë˜ íšŸìˆ˜ê°€ ì ìŠµë‹ˆë‹¤ (${data.num_trades}ê±´). ë” ë§ì€ ê±°ë˜ ê¸°íšŒë¥¼ ì°¾ì•„ë³´ì„¸ìš”.`,
            severity: 'medium'
        });
    }

    // ì•Œë¦¼ í‘œì‹œ
    if (alerts.length > 0) {
        const html = `
            <div class="alert-card ${alerts[0].severity}" style="margin-bottom: 12px;">
                <strong>âš ï¸ ${periodStr} ì£¼ì˜ì‚¬í•­ (${alerts.length}ê±´)</strong>
                <ul style="margin: 8px 0 0 0; padding-left: 20px;">
                    ${alerts.map(a => `<li>${a.message}</li>`).join('')}
                </ul>
            </div>
        `;
        document.getElementById('alerts-container').innerHTML = html;
    } else {
        // ì•Œë¦¼ì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        document.getElementById('alerts-container').innerHTML = '';
    }
}

// ë°˜ì‘í˜• ì°¨íŠ¸
if (chart) {
    window.addEventListener('resize', () => {
        chart.applyOptions({
            width: document.getElementById('profit-chart').offsetWidth
        });
    });

    // ì°¨íŠ¸ ì´ˆê¸° í¬ê¸° ì¡°ì •
    setTimeout(() => {
        chart.applyOptions({
            width: document.getElementById('profit-chart').offsetWidth
        });
    }, 100);
}
</script>
{% endblock %}

{% extends "trading/futures/base.html"%}
{% load humanize %}
{% block content2 %}

<div class="row" id="system">
  <div style="width:100%">
    <div id="profit-chart" style="margin: auto;"></div>
  </div>
  <div id="summary" style="width:100%; margin-top: 40px">
    <div>
      <table class="table table-bordered table-sm">
        <tr>
          <td style="width:10%;"> 시작 </td>
          <td style="width:10%;"> 종료 </td>
          <td style="width:8%;"> 멘탈 </td>
          <td style="width:20%;"> 전략 </td>
          <td style="width:20%;"> 태그 </td>
          <td style="width:20%;"> 기간 </td>
          <td style="width:12%;">  </td>
        </tr>
        <tr>
          <td> <input type="date" class="date" id='start' name="start"> </td>
          <td> <input type="date" class="date" id='end' name="end"> </td>
          <td> <select name="mental" id='mental'>
            <option value=''>    </option>
            <option value='Good'> Good </option>
            <option value='Normal'> Normal </option>
            <option value='Bad'> Bad </option>
            </select>
          </td>
          <td> <select id='strategy' name="strategy">
            <option value=''> </option>
            {% for strategy in strategies%}
            <option value={{strategy.id}} {% if strategy.id == trade.strategy.id %} selected {% endif %}> {{ strategy.name }} </option>
            {% endfor %}
            </select>
          </td>
          <td> 
            <input type="text" id='tags' name="tags">
          </td>
          <td><select id='timeframe' name="timeframe">
            <option value=''>    </option>
            <option value='day'> 1일 이내 </option>
            <option value='swing'> 1일 - 1주 </option>
            <option value='long'> 1주 이상 </option>
            </select>
          </td>
          <td>
            <input type="submit" value="조회" onclick="requestStatData('part');">
          </td>
        </tr>
      </table>
      
      <div style="float: right;"> 업데이트: {{record.date | date:"Y-m-d H:i"}}</div>
    </div>
      <table class="table table-bordered">
          <tr class="table-secondary">
            <th scope="col" style="width:20%">원금</th>
            <th scope="col" style="width:20%">총손익</th>
            <th scope="col" style="width:20%">누적수익</th>
            <th scope="col" style="width:20%">누적손실</th>
            <th scope="col" style="width:20%">수수료</th>
          </tr>
          <tr>
            <td id="principal"></td>
            <td id="revenue"></td>
            <td id="profit"></td>
            <td id="loss"></td>
            <td id="commission"></td>
          </tr>
          <tr class="table-secondary">
            <th scope="col" style="width:20%">수익률</th>
            <th scope="col" style="width:20%">자본인하율</th>
            <th scope="col" style="width:20%">MDD</th>
            <th scope="col" style="width:20%">CAGR</th>
            <th scope="col" style="width:20%">매매횟수</th>
          </tr>
          <tr>
            <td id="roe"></td>
            <td id="dd"></td>
            <td id="mdd"></td>
            <td id="cagr"></td>
            <td id="num_trades"></td>
          </tr>
      </table>
      <table class="table table-bordered">  
          <tr class="table-secondary">
            <th scope="col" style="width:20%">평균손익</th>
            <th scope="col" style="width:20%">손익표준편차</th>
            <th scope="col" style="width:20%">승률</th>
            <th scope="col" style="width:20%">손익비</th>
            <th scope="col" style="width:20%">보유기간</th>
          </tr>
          <tr>
            <td id="avg_profit"></td>
            <td id="std_profit"></td>
            <td id="win_rate"></td>
            <td id="pnl"></td>
            <td></td>
          </tr>
      </table>
  </br>
  <div id="history" style="width:100%"></div>
</div>
{% endblock content2%}

{% block script %}

<script>
//차트 그리기
Highcharts.setOptions({
		lang: { thousandsSep: ',' }
});
var chart = Highcharts.chart('profit-chart', {
            chart: { height: '60%' },// 16:9 ratio}
            legend: { enabled: false},
            title: { text: "Profit Curve" },
            xAxis: { 
                type: 'datetime',
                crosshair:{
                  zIndex: 10,
                }
            },
            yAxis: [{
                title: {text:"수익(원)"},
                labels: {
                  align: 'left',
                  x: 2,
                },
                plotLines: [{
                  color:'#808080',
                  width: 1,
                  value: 0,
                  zIndex: 8,
                  dashStyle: 'dash',

                }],
                lineColor: 'lightgrey',
                lineWidth: 2,
                height: '80%',
            },{
                //opposite: true,
                title: {text:"변동성(%)"},
                labels: {
                  enabled: false,
                },
                lineColor: 'lightgrey',
                lineWidth: 2,
                top: '83%',
                height: '17%',
                offset: 0
            }],
            tooltip: {
              valueDecimals: 0,
              xDateFormat: '%Y-%m-%d',
              crosshairs: true,
              //split: true,
            },
            plotOptions: {
              series: {
                animation: false,
                marker: {
                  enabled: false,
                  radius: 2,
                  symbol: 'circle',
                },
                states: {
                  inactive: { opacity: 1  }
                }
              }
            }
        });

(requestStatData = function(arg){
  if (arg == 'all'){
    filter = '';
  } else if(arg == 'part'){
    filter = {
      start: $('#start').val(),
      end: $('#end').val(),
      mental: $('#mental').val(),
      strategy: $('#strategy').val(),
      tags: $('#tags').val(),
      timeframe: $('#timeframe').val(),
      pnl:$('#timeframe').val()
    }
  }

  $.ajax({
    url: "{% url 'statdata' %}",
    type: "get", //send it through get method
    data: filter,
    success: function(data) {
      $('#principal').text(data.principal+'원');
      $('#revenue').text(data.revenue+'원');
      $('#profit').text(data.profit+'원');
      $('#loss').text(data.loss+'원');
      $('#commission').text(data.commission+'원');
      $('#roe').text(data.roe+' %');
      $('#num_trades').text(data.num_trades);
      $('#avg_profit').text(data.avg_profit+'원');
      $('#std_profit').text(data.std_profit+'원');
      $('#win_rate').text(data.win_rate+'%');
      $('#pnl').text(data.pnl+' : 1');

      //console.log(data);
      //차트 데이터 
      profit = data.principal_num;
      max_profit = profit;
      mdd = 0
      commission =0;
      cum_profit = [];
      cum_commission = [];
      volatility = [];
      console.log(data);
      for (item of data.chart_data){
        
        date = new Date(item[0]).getTime();
        //누적수익: 시드+수익-수수료
        last_profit = profit;
        profit += item[1]-item[2];

        cum_profit.push([date, profit]);
        volatility.push([date, Math.abs(profit/last_profit-1)]);

        commission += item[2];
        cum_commission.push([date, commission]);


        // dd and mdd 계산
        if (profit >= max_profit) { max_profit = profit; };
        dd = 1 - profit/max_profit;
        if (dd >= mdd){ mdd = dd; };
      }
      $('#dd').text(dd.toFixed(2)+'%');
      $('#mdd').text(mdd.toFixed(2)+'%');

      //기존차트 데이터 삭제
      while(chart.series.length > 0)
        chart.series[0].remove(true);

      chart.addSeries({ 
        name: "자산",
        data: cum_profit,
        yAxis: 0,
        tooltip: {valueSuffix: ' 원'},
        type: 'line',
        lineColor:'blue',
        zIndex: 5,
        //marker: { enabled: false}
       });
       chart.addSeries({
        name: "수수료",
        data: cum_commission,
        yAxis: 0,
        tooltip: {valueSuffix: ' 원'},
        type:'line',
        color:	'grey', //#FFFFE0',
        zIndex: 10,
      });
      chart.addSeries({
        name: "변동성",
        data: volatility,
        yAxis: 1,
        tooltip: {valueSuffix: '%', valueDecimals: 2},
        type: 'line',
        color: 'red',
        //marker: { enabled: false}
      });
    }
  });
})('all');
/*
$.get( "", function( data ) {
     value= [];
     r_value=[]; //리스크 제거 자산가치
     volatility=[] //평균변동성
     volatility_day=[] //일변동성
     principal = [] //원금
     for (item of data){
       date = new Date(item[0].slice(0,10)).getTime();
       value.push([date, parseInt(item[1])-item[5]]);
       r_value.push([date,parseInt(item[2])-item[5]]);
       volatility_day.push([date, parseInt(item[3])]);
       volatility.push([date, parseInt(item[4])]);
       principal.push([date, parseInt(item[5])]);
     }

     chart.addSeries({ 
       name: "수익",
       data: value,
       yAxis: 0,
       tooltip: {valueSuffix: ' 원'},
       type: 'area',
       lineColor:'#ADD8E6',
       color: '#B0E0E6',
       zIndex: 5,
       //marker: { enabled: false}
      });
     chart.addSeries({
       name: "위험제거수익",
       data: r_value,
       yAxis: 0,
       tooltip: {valueSuffix: ' 원'},
       type:'area',
       color:	'#EEE8AA', //#FFFFE0',
       //lineColor: '#ADD8E6',
       //marker: { enabled: false}
     });
     chart.addSeries({ 
       name: "원금",
       data: principal,
       yAxis: 1,
       //enableMouseTracking: false,
       //dashStyle: 'dash',
       type: 'line',
       lineColor:'#808080',
      });
     chart.addSeries({
       name: "일변동성",
       data: volatility_day,
       yAxis:2,
       type: 'column',
       color: 'black',
       //marker: { enabled: false}
     });
     chart.addSeries({
       name: "평균 변동성",
       data: volatility,
       yAxis:2,
       type: 'line',
       color:'tomato',
       //marker: { enabled: false}
     });
});
*/
</script>
{% endblock script %}

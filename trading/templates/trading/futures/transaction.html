{% extends "trading/futures/base.html"%}
{% load humanize %}

{% block content %}
<div class='container-mobile'>
  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #f0f0f0;">
    <a href="{% url 'futurestrade' page=1 %}"
       style="flex: 1; padding: 12px; text-align: center; text-decoration: none; font-weight: 500; color: #757575;">
      ê±°ë˜ ë‚´ì—­
    </a>
    <a href="{% url 'transaction' page=1 %}"
       style="flex: 1; padding: 12px; text-align: center; text-decoration: none; font-weight: 600; color: #2962FF; border-bottom: 3px solid #2962FF; margin-bottom: -2px;">
      ì²´ê²° ê¸°ë¡
    </a>
  </div>

  <!-- ì•¡ì…˜ ì¹´ë“œ (ìƒë‹¨) -->
  <div class="card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ“Š ë°ì´í„° ê´€ë¦¬</h6>

    <!-- í™˜ìœ¨ ì •ë³´ -->
    <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
      <div style="font-size: 12px; color: #757575; margin-bottom: 4px;">
        í™˜ìœ¨ ({{currencies.first.date|date:'Yë…„ mì›” dì¼'}})
      </div>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        {% for currency in currencies %}
        <div>
          <span style="font-weight: 600;">{{currency.symbol}}</span>
          <span style="color: #757575;">{{currency.rate|floatformat:2}}</span>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
    <div style="display: grid; gap: 8px;">
      <button class="btn btn-primary w-100" onclick="updateCurrency()" id="btn-currency">
        ğŸ”„ 1ë‹¨ê³„: í™˜ìœ¨ ê°±ì‹ 
      </button>

      <form action="{% url 'transaction' page=1 %}" method='post' style="margin: 0;">
        {% csrf_token %}
        <button type="submit" class="btn btn-success w-100" id="btn-sync">
          ğŸ“¥ 2ë‹¨ê³„: ì²´ê²°ê¸°ë¡ ì¶”ê°€
        </button>
      </form>

      <button class="btn btn-warning w-100" onclick="createTrades()" id="btn-create" style="color: white;">
        âš™ï¸ 3ë‹¨ê³„: ê±°ë˜ë‚´ì—­ ìƒì„±
      </button>
    </div>

    <div style="margin-top: 12px; padding: 8px; background: #fff3cd; border-radius: 8px; font-size: 12px;">
      <strong>âš ï¸ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰:</strong> ê° ë‹¨ê³„ë¥¼ í™•ì¸ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”
    </div>
  </div>

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ (ìƒë‹¨) -->
  {% if is_paginated %}
    <nav aria-label="Page navigator" style="margin-bottom: 16px;">
      <ul class="pagination pagination-sm justify-content-center">
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'transaction' page=1 %}">ì²˜ìŒ</a>
        </li>
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'transaction' page=page_obj.previous %}">ì´ì „</a>
        </li>
        <li class="page-item active">
          <span class="page-link">{{page_obj.page}} / {{page_obj.num_page}}</span>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'transaction' page=page_obj.next %}">ë‹¤ìŒ</a>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'transaction' page=page_obj.num_page %}">ë§ˆì§€ë§‰</a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <!-- ì²´ê²° ë‚´ì—­ ì¹´ë“œ -->
  <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ“‹ ì²´ê²° ë‚´ì—­</h6>

  {% for transaction in transactions %}
  <div class="card" style="margin-bottom: 12px;" onclick="toggleTransactionDetail('{{transaction.id}}')">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
      <div>
        <div style="font-weight: 600; color: #333;">
          {{transaction.instrument.name}}
        </div>
        <div style="font-size: 12px; color: #757575;">
          {{transaction.date|date:"Y-m-d H:i"}}
        </div>
      </div>
      <div style="text-align: right;">
        <div class="position {% if transaction.position == 1 %}long{% else %}short{% endif %}" style="margin-bottom: 4px;">
          {% if transaction.position == 1 %}Long{% else %}Short{% endif %}
        </div>
        <div style="font-size: 12px; color: #757575;">
          {% if transaction.trade %}
          ê±°ë˜ #{{transaction.trade.id}}
          {% else %}
          <span style="color: #f57c00;">ë¯¸ë¶„ë¥˜</span>
          {% endif %}
        </div>
      </div>
    </div>

    <div style="display: flex; justify-content: space-between; font-size: 14px;">
      <span>ê°€ê²©: <strong>{{transaction.price.normalize}}</strong></span>
      <span>ìˆ˜ìˆ˜ë£Œ: {{transaction.commission|floatformat:2}}</span>
    </div>

    <!-- ìƒì„¸ ì •ë³´ (í¼ì¹¨) -->
    <div id="detail-{{transaction.id}}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f0f0f0;">
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px;">
        <div>
          <div style="color: #757575;">ê³„ì¢Œ</div>
          <div>{{transaction.account}}</div>
        </div>
        <div>
          <div style="color: #757575;">ì²´ê²°ë²ˆí˜¸</div>
          <div>{{transaction.ebest_id}}</div>
        </div>
        <div>
          <div style="color: #757575;">ì¢…ë¥˜</div>
          <div>{{transaction.type}}</div>
        </div>
        <div>
          <div style="color: #757575;">ì½”ë“œ</div>
          <div style="font-size: 11px;">{{transaction.ebest_code}}</div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- ë¹ˆ ìƒíƒœ -->
  {% if not transactions %}
  <div class="empty-state">
    <p>ì²´ê²° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
    <p style="font-size: 12px; margin-top: 8px;">ìœ„ì˜ "ì²´ê²°ê¸°ë¡ ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì„¸ìš”</p>
  </div>
  {% endif %}

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ (í•˜ë‹¨) -->
  {% if is_paginated %}
    <nav aria-label="Page navigator" style="margin-top: 16px;">
      <ul class="pagination pagination-sm justify-content-center">
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'transaction' page=1 %}">ì²˜ìŒ</a>
        </li>
        <li class="page-item active">
          <span class="page-link">{{page_obj.page}} / {{page_obj.num_page}}</span>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'transaction' page=page_obj.num_page %}">ë§ˆì§€ë§‰</a>
        </li>
      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
// ì²´ê²° ë‚´ì—­ ìƒì„¸ í† ê¸€
function toggleTransactionDetail(id) {
  const detail = document.getElementById('detail-' + id);
  if (detail.style.display === 'none') {
    // ë‹¤ë¥¸ ëª¨ë“  ìƒì„¸ ë‹«ê¸°
    document.querySelectorAll('[id^="detail-"]').forEach(el => {
      el.style.display = 'none';
    });
    detail.style.display = 'block';
  } else {
    detail.style.display = 'none';
  }
}

// í™˜ìœ¨ ê°±ì‹ 
function updateCurrency() {
  if (!confirm('í™˜ìœ¨ì„ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

  const btn = document.getElementById('btn-currency');
  btn.disabled = true;
  btn.textContent = 'ê°±ì‹  ì¤‘...';

  location.href = "{% url 'transaction' page=1 %}?currency=true";
}

// ê±°ë˜ë‚´ì—­ ìƒì„±
function createTrades() {
  if (!confirm('ì²´ê²°ê¸°ë¡ì—ì„œ ê±°ë˜ë‚´ì—­ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ì˜: ì²´ê²°ê¸°ë¡ì„ í™•ì¸í•œ í›„ ì‹¤í–‰í•˜ì„¸ìš”.')) return;

  const btn = document.getElementById('btn-create');
  btn.disabled = true;
  btn.textContent = 'ìƒì„± ì¤‘...';

  location.href = "{% url 'transaction' page=1 %}?create_trades=true";
}

// í¼ ì œì¶œ ì‹œ ë²„íŠ¼ ë¹„í™œì„±í™”
document.querySelector('form').addEventListener('submit', function() {
  const btn = document.getElementById('btn-sync');
  btn.disabled = true;
  btn.textContent = 'ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
});
</script>
{% endblock %}

{% extends "trading/futures/base.html" %}
{% load humanize %}

{% block content %}
<div class="container-mobile">
  {% if no_data %}
  <!-- ë°ì´í„° ì—†ìŒ -->
  <div class="empty-state">
    <p>ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
    <p style="font-size: 12px; margin-top: 8px;">ê±°ë˜ë¥¼ ì§„í–‰í•œ í›„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”</p>
  </div>
  {% else %}

  <!-- ì£¼ìš” ì§€í‘œ -->
  <div class="card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ“Š ì£¼ìš” ì§€í‘œ</h6>

    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
      <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ìµœëŒ€ ë‚™í­ (MDD)</div>
        <div style="font-size: 20px; font-weight: bold; color: #f44336;">â‚©{{ max_drawdown|floatformat:0|intcomma }}</div>
      </div>
      <div style="background: #f5f5f5; padding: 12px; border-radius: 8px; text-align: center;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">í‰ê·  ë³´ìœ  ì‹œê°„</div>
        <div style="font-size: 20px; font-weight: bold; color: #2962FF;">{{ avg_duration|floatformat:1 }}h</div>
      </div>
    </div>

    <div style="margin-top: 12px; padding: 8px; background: #e8f5e9; border-radius: 8px; font-size: 12px; color: #2e7d32;">
      <strong>ğŸ’¡ Tip:</strong> MDDê°€ ë‚®ì„ìˆ˜ë¡ ì•ˆì •ì ì¸ ê±°ë˜ì…ë‹ˆë‹¤.
    </div>
  </div>

  <!-- ì›”ë³„ ìˆ˜ìµ ì°¨íŠ¸ -->
  <div class="chart-card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ“… ì›”ë³„ ìˆ˜ìµ ì¶”ì´ <span style="font-size: 11px; color: #757575; font-weight: normal;">(ë‹¨ìœ„: ë§Œì›)</span></h6>
    <div id="monthly-chart" style="height: 250px;"></div>
  </div>

  <!-- ë©˜íƒˆ ìƒíƒœë³„ ì„±ê³¼ -->
  {% if mental_stats %}
  <div class="card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ§  ë©˜íƒˆ ìƒíƒœë³„ ì„±ê³¼</h6>
    {% for stat in mental_stats %}
    <div style="padding: 10px 0; {% if not forloop.last %}border-bottom: 1px solid #f0f0f0;{% endif %}">
      <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
        <div>
          <span style="font-weight: 600;">
            {% if stat.mental == 'Good' %}ğŸ˜Š Good
            {% elif stat.mental == 'Normal' %}ğŸ˜ Normal
            {% elif stat.mental == 'Bad' %}ğŸ˜° Bad
            {% else %}{{ stat.mental }}{% endif %}
          </span>
          <span style="color: #757575; font-size: 12px; margin-left: 8px;">{{ stat.num_trades }}ê±´</span>
        </div>
        <div style="font-weight: bold; {% if stat.total_profit > 0 %}color: #d32f2f;{% else %}color: #1976d2;{% endif %}">
          {% if stat.total_profit > 0 %}+{% endif %}â‚©{{ stat.total_profit|floatformat:0|intcomma }}
        </div>
      </div>
      <div style="display: flex; gap: 16px; font-size: 12px; color: #757575;">
        <span>ìŠ¹ë¥ : <strong>{{ stat.win_rate|floatformat:0 }}%</strong></span>
        <span>í‰ê· : <strong>â‚©{{ stat.avg_profit|floatformat:0|intcomma }}</strong></span>
      </div>
    </div>
    {% endfor %}

    <div style="margin-top: 12px; padding: 8px; background: #fff3cd; border-radius: 8px; font-size: 12px;">
      <strong>ğŸ’¡ ë¶„ì„:</strong> ë©˜íƒˆ ìƒíƒœê°€ ì¢‹ì„ ë•Œ ë” ë‚˜ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ë‚˜ìš”?
    </div>
  </div>
  {% endif %}

  <!-- ìš”ì¼ë³„ ì„±ê³¼ -->
  {% if weekday_stats %}
  <div class="card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ“† ìš”ì¼ë³„ ì„±ê³¼</h6>
    {% for stat in weekday_stats %}
    <div style="padding: 8px 12px; margin-bottom: 6px; background: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <span style="font-weight: 600;">
          {% if stat.weekday == 1 %}ì¼ìš”ì¼
          {% elif stat.weekday == 2 %}ì›”ìš”ì¼
          {% elif stat.weekday == 3 %}í™”ìš”ì¼
          {% elif stat.weekday == 4 %}ìˆ˜ìš”ì¼
          {% elif stat.weekday == 5 %}ëª©ìš”ì¼
          {% elif stat.weekday == 6 %}ê¸ˆìš”ì¼
          {% elif stat.weekday == 7 %}í† ìš”ì¼
          {% endif %}
        </span>
        <span style="color: #757575; font-size: 12px; margin-left: 8px;">{{ stat.num_trades }}ê±´</span>
      </div>
      <div style="display: flex; align-items: center; gap: 12px;">
        <span style="font-size: 12px; color: #757575;">ìŠ¹ë¥  {{ stat.win_rate|floatformat:0 }}%</span>
        <span style="font-weight: bold; {% if stat.total_profit > 0 %}color: #d32f2f;{% else %}color: #1976d2;{% endif %}">
          {% if stat.total_profit > 0 %}+{% endif %}â‚©{{ stat.total_profit|floatformat:0|intcomma }}
        </span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- ì†ìµ ë¶„í¬ -->
  <div class="chart-card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ“Š ì†ìµ ë¶„í¬ë„ <span style="font-size: 11px; color: #757575; font-weight: normal;">(ë‹¨ìœ„: ë§Œì›)</span></h6>
    <div id="distribution-chart" style="height: 250px;"></div>
    <div style="margin-top: 12px; padding: 8px; background: #f5f5f5; border-radius: 8px; font-size: 12px; color: #616161;">
      ë¶„í¬ê°€ ì˜¤ë¥¸ìª½(+)ìœ¼ë¡œ ì¹˜ìš°ì³ ìˆì„ìˆ˜ë¡ ìˆ˜ìµ ê±°ë˜ê°€ ë§ìŠµë‹ˆë‹¤.
    </div>
  </div>

  <!-- ë§¤ë§¤ ê°„ ë…ë¦½ì„± ê²€ì • -->
  <div class="card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ”¬ ë§¤ë§¤ ê°„ ë…ë¦½ì„± ê²€ì •</h6>

    <div style="margin-bottom: 12px; padding: 12px; background: #e3f2fd; border-radius: 8px;">
      <div style="font-size: 12px; color: #1565c0; margin-bottom: 8px;">
        <strong>ì¢…í•© í‰ê°€:</strong>
      </div>
      <div style="font-size: 13px; color: #0d47a1;">
        {{ independence_test.overall_interpretation }}
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
      <div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ëŸ° ê²€ì • (Runs Test)</div>
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px;">
          {{ independence_test.runs_interpretation }}
        </div>
        {% if independence_test.runs_test_p %}
        <div style="font-size: 11px; color: #9e9e9e;">
          p-value: {{ independence_test.runs_test_p|floatformat:4 }}
          {% if independence_test.runs_test_p < 0.05 %}
          <span style="color: #f44336;">*</span>
          {% endif %}
        </div>
        {% endif %}
      </div>

      <div style="background: #f5f5f5; padding: 12px; border-radius: 8px;">
        <div style="font-size: 11px; color: #757575; margin-bottom: 4px;">ìê¸°ìƒê´€ (Lag 1)</div>
        {% if independence_test.autocorr_lag1 is not None %}
        <div style="font-size: 16px; font-weight: bold; color: {% if independence_test.autocorr_lag1 > 0.3 or independence_test.autocorr_lag1 < -0.3 %}#f44336{% else %}#4CAF50{% endif %};">
          {{ independence_test.autocorr_lag1|floatformat:3 }}
        </div>
        <div style="font-size: 11px; color: #9e9e9e;">
          {% if independence_test.autocorr_lag1 > 0.3 or independence_test.autocorr_lag1 < -0.3 %}
          ìƒê´€ê´€ê³„ ìˆìŒ
          {% else %}
          ë…ë¦½ì 
          {% endif %}
        </div>
        {% else %}
        <div style="font-size: 14px; color: #9e9e9e;">ë°ì´í„° ë¶€ì¡±</div>
        {% endif %}
      </div>
    </div>

    {% if independence_test.win_after_win is not None and independence_test.win_after_loss is not None %}
    <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
      <div style="font-size: 12px; color: #856404; margin-bottom: 8px;">
        <strong>ì¡°ê±´ë¶€ ìŠ¹ë¥  ë¶„ì„:</strong>
      </div>
      <div style="display: flex; justify-content: space-around; margin-bottom: 8px;">
        <div style="text-align: center;">
          <div style="font-size: 11px; color: #856404;">ìŠ¹ë¦¬ í›„ ìŠ¹ë¥ </div>
          <div style="font-size: 20px; font-weight: bold; color: #d32f2f;">
            {{ independence_test.win_after_win|floatformat:1 }}%
          </div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 11px; color: #856404;">íŒ¨ë°° í›„ ìŠ¹ë¥ </div>
          <div style="font-size: 20px; font-weight: bold; color: #1976d2;">
            {{ independence_test.win_after_loss|floatformat:1 }}%
          </div>
        </div>
        {% if independence_test.win_after_draw is not None %}
        <div style="text-align: center;">
          <div style="font-size: 11px; color: #856404;">ë¬´ìŠ¹ë¶€ í›„ ìŠ¹ë¥ </div>
          <div style="font-size: 20px; font-weight: bold; color: #ff9800;">
            {{ independence_test.win_after_draw|floatformat:1 }}%
          </div>
        </div>
        {% endif %}
      </div>
      {% if independence_test.conditional_test_p %}
      <div style="font-size: 11px; color: #856404; text-align: center;">
        í†µê³„ì  ìœ ì˜ì„±: p = {{ independence_test.conditional_test_p|floatformat:4 }}
        {% if independence_test.conditional_test_p < 0.05 %}
        <span style="color: #f44336;">** ìœ ì˜í•¨</span>
        {% else %}
        <span style="color: #4CAF50;">ë…ë¦½ì </span>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% endif %}

    <div style="margin-top: 12px; padding: 8px; background: #e8f5e9; border-radius: 8px; font-size: 12px; color: #2e7d32;">
      <strong>ğŸ’¡ í•´ì„:</strong>
      <ul style="margin: 4px 0 0 0; padding-left: 20px;">
        <li>ëŸ° ê²€ì •: ìŠ¹/ë¬´/íŒ¨ê°€ ëœë¤í•˜ê²Œ ë°œìƒí•˜ëŠ”ì§€ í™•ì¸</li>
        <li>ìê¸°ìƒê´€: ì´ì „ ê±°ë˜ ì†ìµì´ ë‹¤ìŒ ê±°ë˜ì— ì˜í–¥ì„ ì£¼ëŠ”ì§€ ì¸¡ì •</li>
        <li>ì¡°ê±´ë¶€ ìŠ¹ë¥ : ìŠ¹ë¦¬/ë¬´ìŠ¹ë¶€/íŒ¨ë°° í›„ ë‹¤ìŒ ê±°ë˜ ì„±ê³¼ ë¹„êµ</li>
        <li>ë¬´ìŠ¹ë¶€ ê¸°ì¤€: ì§„ì…ê°€ ëŒ€ë¹„ Â±5í‹± ì´ë‚´</li>
      </ul>
    </div>
  </div>

  <!-- ê°œì„  ì œì•ˆ -->
  <div class="card" style="margin-bottom: 16px;">
    <h6 style="margin-bottom: 12px; font-weight: 600;">ğŸ’¬ ë¶„ì„ ê²°ê³¼</h6>
    <ul style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: #616161;">
      {% if max_drawdown > 5000 %}
      <li>ìµœëŒ€ ë‚™í­ì´ í½ë‹ˆë‹¤. ë¦¬ìŠ¤í¬ ê´€ë¦¬ë¥¼ ê°•í™”í•˜ì„¸ìš”.</li>
      {% else %}
      <li>ìµœëŒ€ ë‚™í­ì´ ì˜ ê´€ë¦¬ë˜ê³  ìˆìŠµë‹ˆë‹¤.</li>
      {% endif %}

      {% if avg_duration < 1 %}
      <li>í‰ê·  ë³´ìœ  ì‹œê°„ì´ 1ì‹œê°„ ë¯¸ë§Œì…ë‹ˆë‹¤. ìŠ¤ìº˜í•‘ ìŠ¤íƒ€ì¼ì´ë„¤ìš”.</li>
      {% elif avg_duration < 24 %}
      <li>í‰ê·  ë³´ìœ  ì‹œê°„ì´ {{avg_duration|floatformat:1}}ì‹œê°„ì…ë‹ˆë‹¤. ë°ì´ íŠ¸ë ˆì´ë”© ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤.</li>
      {% else %}
      <li>í‰ê·  ë³´ìœ  ì‹œê°„ì´ {{avg_duration|floatformat:0}}ì‹œê°„ì…ë‹ˆë‹¤. ìŠ¤ìœ™/ì¥ê¸° íŠ¸ë ˆì´ë”© ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤.</li>
      {% endif %}

      {% if mental_stats.0.mental == 'Good' %}
      <li>Good ë©˜íƒˆì¼ ë•Œ ìˆ˜ìµì´ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤. ë©˜íƒˆ ê´€ë¦¬ê°€ ì¤‘ìš”í•©ë‹ˆë‹¤!</li>
      {% endif %}

      <li>ê°€ì¥ ìˆ˜ìµì´ ì¢‹ì€ ìš”ì¼ì— ì§‘ì¤‘í•˜ëŠ” ê²ƒë„ ì¢‹ì€ ì „ëµì…ë‹ˆë‹¤.</li>
    </ul>
  </div>

  {% endif %}
</div>
{% endblock %}

{% block script %}
<script>
{% if not no_data %}
// ì›”ë³„ ìˆ˜ìµ ì°¨íŠ¸
try {
  if (typeof LightweightCharts === 'undefined') {
    throw new Error('LightweightCharts library not loaded');
  }

  const monthlyData = {{ monthly_data|safe }};
  if (monthlyData && monthlyData.length > 0) {
    const monthlyChart = LightweightCharts.createChart(document.getElementById('monthly-chart'), {
      width: document.getElementById('monthly-chart').offsetWidth,
      height: 250,
      layout: {
        textColor: '#333',
        background: { color: '#fff' }
      },
      grid: {
        vertLines: { color: '#f0f0f0' },
        horzLines: { color: '#f0f0f0' }
      },
      timeScale: {
        timeVisible: true,
        fixLeftEdge: true,
        fixRightEdge: true,
      },
      localization: {
        priceFormatter: function(price) {
          return Math.round(price).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
      }
    });

    const monthlyHistogram = monthlyChart.addHistogramSeries({
      color: '#2196F3',
      priceFormat: {
        type: 'volume',
      },
    });

    const chartData = monthlyData.map(item => ({
      time: item.month,
      value: item.total_profit / 10000,  // ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜
      color: item.total_profit >= 0 ? '#d32f2f' : '#1976d2'  // ìˆ˜ìµ ë¹¨ê°•, ì†ì‹¤ íŒŒë‘
    }));

    monthlyHistogram.setData(chartData);
    monthlyChart.timeScale().fitContent();
  }
} catch (error) {
  console.error('Monthly chart error:', error);
  document.getElementById('monthly-chart').innerHTML = '<p style="color: red; padding: 20px;">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨</p>';
}

// ì†ìµ ë¶„í¬ ì°¨íŠ¸ (íˆìŠ¤í† ê·¸ë¨)
try {
  const profitDist = {{ profit_distribution|safe }};
  if (profitDist && profitDist.length > 0) {
    // êµ¬ê°„ë³„ ë¶„ë¥˜ (50,000ì› ë‹¨ìœ„ = ì²œì›ìœ¼ë¡œ 50)
    const bins = {};
    const binSize = 50000;  // 50,000ì› ë‹¨ìœ„ë¡œ êµ¬ê°„ ë¶„ë¥˜

    profitDist.forEach(profit => {
      const bin = Math.floor(profit / binSize) * binSize;
      bins[bin] = (bins[bin] || 0) + 1;
    });

    // binsë¥¼ ì •ë ¬
    const sortedBins = Object.keys(bins).sort((a, b) => parseFloat(a) - parseFloat(b));

    // ë‚ ì§œ-bin ê°’ ë§¤í•‘ì„ ì €ì¥ (ê¸€ë¡œë²Œ ìŠ¤ì½”í”„ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
    window.distBinMapping = {};
    window.distBinSize = binSize;

    const distChart = LightweightCharts.createChart(document.getElementById('distribution-chart'), {
      width: document.getElementById('distribution-chart').offsetWidth,
      height: 250,
      layout: {
        textColor: '#333',
        background: { color: '#fff' }
      },
      grid: {
        vertLines: { color: '#f0f0f0' },
        horzLines: { color: '#f0f0f0' }
      },
      rightPriceScale: {
        scaleMargins: {
          top: 0.1,
          bottom: 0
        }
      },
      timeScale: {
        tickMarkFormatter: (time) => {
          // timeì„ ë¬¸ìì—´ë¡œ ë³€í™˜
          const timeStr = typeof time === 'object' ? time.year + '-' + String(time.month).padStart(2, '0') + '-' + String(time.day).padStart(2, '0') : time;
          const binValue = window.distBinMapping[timeStr];
          if (binValue !== undefined) {
            return (binValue / 10000).toFixed(1);  // ë§Œì› ë‹¨ìœ„ë¡œ í‘œì‹œ
          }
          return '';
        }
      },
      localization: {
        timeFormatter: (time) => {
          // timeì„ ë¬¸ìì—´ë¡œ ë³€í™˜
          const timeStr = typeof time === 'object' ? time.year + '-' + String(time.month).padStart(2, '0') + '-' + String(time.day).padStart(2, '0') : time;
          const binValue = window.distBinMapping[timeStr];
          if (binValue !== undefined) {
            const start = (binValue / 10000).toFixed(1);
            const end = ((binValue + window.distBinSize) / 10000).toFixed(1);
            return `${start}~${end} ë§Œì›`;
          }
          return '';
        },
        priceFormatter: function(price) {
          return Math.round(price).toString() + 'ê±´';
        }
      }
    });

    const histogram = distChart.addHistogramSeries({
      color: '#2962FF',
      base: 0
    });

    // íˆìŠ¤í† ê·¸ë¨ ë°ì´í„° ìƒì„±
    const baseDate = new Date('2024-01-01');
    const histData = sortedBins.map((bin, index) => {
      const date = new Date(baseDate);
      date.setDate(baseDate.getDate() + index);
      const timeStr = date.toISOString().split('T')[0];

      // ë§¤í•‘ ì €ì¥
      window.distBinMapping[timeStr] = parseFloat(bin);

      return {
        time: timeStr,
        value: bins[bin],
        color: parseFloat(bin) >= 0 ? '#4CAF50' : '#f44336'
      };
    });

    histogram.setData(histData);
  }
} catch (error) {
  console.error('Distribution chart error:', error);
  document.getElementById('distribution-chart').innerHTML = '<p style="color: red; padding: 20px;">ì°¨íŠ¸ ë¡œë”© ì‹¤íŒ¨: ' + error.message + '</p>';
}

// ë°˜ì‘í˜•
window.addEventListener('resize', () => {
  if (document.getElementById('monthly-chart')) {
    const charts = document.querySelectorAll('.chart-card > div');
    charts.forEach(chart => {
      const chartInstance = LightweightCharts.createChart(chart, {
        width: chart.offsetWidth
      });
    });
  }
});
{% endif %}
</script>
{% endblock %}

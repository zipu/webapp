{% extends "trading/futures/base.html"%}
{% load humanize %}
{% load static %}
{% block content2 %}
<div class='row' style="width:60%; margin: 0 auto;">
  {% if is_paginated %}
    <nav aria-label="Page navigator">
      <ul class="pagination pagination-sm justify-content-center">
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=1 %}" aria-label="First">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.previous %}" aria-label="Previous">
            <span aria-hidden="true">&lt;</span>
          </a>
        </li>
        {% for page in page_obj.rng %}
          {% if page_obj.page == page %}
            <li class="page-item active">
              <a class="page-link" href="">{{page}}</a>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="{% url 'futurestrade' page=page %}">{{page}}</a>
            </li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.next %}" aria-label="Previous">
            <span aria-hidden="true">&gt;</span>
          </a>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.num_page %}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <table class="table table-sm table-bordered" style="font-size:small">
      <tr class="table table-secondary">
        <td scope="col" rowspan=2>계좌</td>
        <td scope="col" rowspan=2>시작일</td>
        <td scope="col" rowspan=2>상품</td>
        <td scope="col" rowspan=2>종류</td>
        <td scope="col" rowspan=2>코드</td>
        <td scope="col" rowspan=2>포지션</td>
        <td scope="col" colspan=2>진입</td>
        <td scope="col" colspan=2>청산</td>
        <td scope="col" rowspan=2>잔여</td>
        <td scope="col" rowspan=2>실현</td>
        <td scope="col" rowspan=2>틱</td>
        <td scope="col" rowspan=2>통화</td>

      </tr>
      <tr class="table table-secondary">
        <td scope="col"> 가격 </td>
        <td scope="col"> 수량 </td>
        <td scope="col"> 가격 </td>
        <td scope="col"> 수량 </td>
      </tr>
 
      {% for trade, entries, exits, cons in data %}
      <tr class='trade' onclick="ShowDetail({{trade.id}})"
       {% if trade.is_open %} bgcolor='azure' 
       {% elif not trade.entry_strategy %} bgcolor='#FBEEE6'
       {% endif %}>
          <td>{{trade.account}} </td>
          <td>{{trade.pub_date | date:"Y-m-d"}} </td>
          <td>{{trade.instrument.name}} </td>
          <td>{{trade.type}} </td>
          <td>{{trade.ebest_code}} </td>
          <td style={% if trade.position == 1 %} 'color:red' {% else %} 'color:blue' {% endif %}>
            {% if trade.position == 1 %}
             Long
            {% else %}
             Short
            {% endif %}
          </td>
          <td>
            <table class="table table-sm table-bordered" style="margin:0; padding:0;">
              {% for entry in entries %}
              <tr><td> {{entry.price.normalize}} </td></tr>
              {% endfor %}
            </table>
          </td>
          <td>
            <table class="table table-sm table-bordered" style="margin:0; padding:0;">
              {% for entry in entries %}
              <tr><td> {{entry.cnt}} </td></tr>
              {% endfor %}
            </table>
          </td>
          <td>
            <table class="table table-sm table-bordered" style="margin:0; padding:0;">
              {% for exit in exits %}
              <tr><td> {{exit.price.normalize}} </td></tr>
              {% endfor %}
            </table>
          </td>
          <td>
            <table class="table table-sm table-bordered" style="margin:0; padding:0;">
              {% for exit in exits %}
              <tr><td> {{exit.cnt}} </td></tr>
              {% endfor %}
            </table>
          </td>
          <td>
            {{cons}}
          </td>
          <td style="color: {% if trade.realized_profit > 0 %} red {% elif trade.realized_profit < 0 %} blue {% endif%}">
            {{trade.realized_profit.normalize}}
          </td>
          <td style="color: {% if trade.realized_profit > 0 %} red {% elif trade.realized_profit < 0 %} blue {% endif%}">
            {{trade.realized_profit_ticks |floatformat:1}}
          </td>
          <td>{{trade.instrument.currency.symbol}} </td>
      </tr>
      <!-- 매매 디테일 뷰 -->
      <tr id='{{trade.id}}' style='display:none;'> 
        <td colspan=14 style='padding:0;'>
          <div class="trade-detail-container">
            <!-- 기본 정보 그리드 -->
            <div class="detail-grid">
              <div class="detail-item">
                <label>평균매입가</label>
                <span>{{trade.avg_entry_price.normalize|floatformat:trade.instrument.decimal_places}}</span>
              </div>
              <div class="detail-item">
                <label>평균청산가</label>
                <span>{{trade.avg_exit_price.normalize|floatformat:trade.instrument.decimal_places}}</span>
              </div>
              <div class="detail-item">
                <label>손절가</label>
                <span>{{ trade.stop_price.normalize }}</span>
              </div>
              <div class="detail-item">
                <label>타임프레임</label>
                <span>{{ trade.timeframe }}</span>
              </div>
              <div class="detail-item">
                <label>멘탈</label>
                <span>{{trade.mental |default_if_none:"-"}}</span>
              </div>
              <div class="detail-item">
                <label>진입전략</label>
                <span>{{ trade.entry_strategy.name }}</span>
              </div>
              <div class="detail-item">
                <label>청산전략</label>
                <span>{{trade.exit_strategy.name}}</span>
              </div>
              <div class="detail-item">
                <label>수수료</label>
                <span>{{ trade.commission.normalize }}</span>
              </div>
              <div class="detail-item">
                <label>지속시간</label>
                <span>{{ trade.duration|default:"-" }}</span>
              </div>
              <div class="detail-item">
                <label>상태</label>
                <span>{% if trade.is_open %}진행중{% else %}완료{% endif %}</span>
              </div>
            </div>
            
            <!-- 진입/청산 이유 섹션 -->
            <div class="reason-section">
              <div class="reason-entry">
                <h6>진입 이유</h6>
                <div class="reason-tags">
                  {% for tag in trade.entry_tags.all %}
                  <span class="reason-tag">{{tag.name}}</span>
                  {% endfor %}
                </div>
                <div class="reason-content">
                  {{ trade.entry_reason |linebreaks }}
                </div>
              </div>
              <div class="reason-exit">
                <h6>청산 이유</h6>
                <div class="reason-tags">
                  {% for tag in trade.exit_tags.all %}
                  <span class="reason-tag">{{tag.name}}</span>
                  {% endfor %}
                </div>
                <div class="reason-content">
                  {{ trade.exit_reason |linebreaks}}
                </div>
              </div>
            </div>
            
            <!-- 수정 버튼 -->
            <div class="action-section">
              <button type="button" class="btn btn-primary btn-sm" onclick="ShowUpdateDetal({{trade.id}});">
                수정
              </button>
            </div>
          </div>
      </td>
      </tr>
      <!-- 매매 디테일 업데이트 뷰 -->
      <tr id='{{trade.id}}-mod' style='display:none;'> 
        <td colspan=14 style='padding:0;'>
          <form action="{% url 'futurestrade' page=1 %}" method='post'>
           {% csrf_token %}
           <input type='hidden' value='{{trade.id}}' name='id'></input>
           
           <div class="trade-edit-container">
             <!-- 수정 가능한 기본 정보 그리드 -->
             <div class="edit-grid">
               <div class="edit-item">
                 <label>평균매입가</label>
                 <span>{{trade.avg_entry_price.normalize|floatformat:trade.instrument.decimal_places}}</span>
               </div>
               <div class="edit-item">
                 <label>평균청산가</label>
                 <span>{{trade.avg_exit_price.normalize|floatformat:trade.instrument.decimal_places}}</span>
               </div>
               <div class="edit-item">
                 <label>손절가</label>
                 <input type="number" step="any" value='{{trade.stop_price.normalize}}' name='stopprice' class="form-control form-control-sm">
               </div>
               <div class="edit-item">
                 <label>타임프레임</label>
                 <span>{{ trade.timeframe }}</span>
               </div>
               <div class="edit-item">
                 <label>멘탈</label>
                 <select name="mental" class="form-select form-select-sm">
                   <option value=''>선택</option>
                   <option value='Good' {% if trade.mental == 'Good' %} selected {% endif %}>Good</option>
                   <option value='Normal' {% if trade.mental == 'Normal' %} selected {% endif %}>Normal</option>
                   <option value='Bad' {% if trade.mental == 'Bad' %} selected {% endif %}>Bad</option>
                 </select>
               </div>
               <div class="edit-item">
                 <label>진입전략</label>
                 <select name="entry_strategy" class="form-select form-select-sm">
                   <option value=''>선택</option>
                   {% for strategy in entry_strategies%}
                   <option value={{strategy.id}} {% if strategy.id == trade.entry_strategy.id %} selected {% endif %}>{{ strategy.name }}</option>
                   {% endfor %}
                 </select>
               </div>
               <div class="edit-item">
                 <label>청산전략</label>
                 <select name="exit_strategy" class="form-select form-select-sm">
                   <option value=''>선택</option>
                   {% for strategy in exit_strategies%}
                   <option value={{strategy.id}} {% if strategy.id == trade.exit_strategy.id %} selected {% endif %}>{{ strategy.name }}</option>
                   {% endfor %}
                 </select>
               </div>
               <div class="edit-item">
                 <label>수수료</label>
                 <span>{{ trade.commission.normalize }}</span>
               </div>
             </div>
             
             <!-- 진입/청산 이유 편집 섹션 -->
             <div class="reason-edit-section">
               <div class="reason-edit-entry">
                 <h6>진입 이유</h6>
                 <div class="mb-2">
                   <label class="form-label">태그</label>
                   <input type="text" class="form-control form-control-sm" name="entrytags" 
                     value="{% for tag in trade.entry_tags.all %}{{tag.name}};{% endfor %}" 
                     placeholder="태그1;태그2;태그3">
                 </div>
                 <div>
                   <label class="form-label">이유</label>
                   <textarea name="entryreason" placeholder="진입 이유" rows="4" class="form-control form-control-sm">{{trade.entry_reason }}</textarea>
                 </div>
               </div>
               <div class="reason-edit-exit">
                 <h6>청산 이유</h6>
                 <div class="mb-2">
                   <label class="form-label">태그</label>
                   <input type="text" class="form-control form-control-sm" name="exittags" 
                     value="{% for tag in trade.exit_tags.all %}{{tag.name}};{% endfor %}" 
                     placeholder="태그1;태그2;태그3">
                 </div>
                 <div>
                   <label class="form-label">이유</label>
                   <textarea name="exitreason" placeholder="청산 이유" rows="4" class="form-control form-control-sm">{{trade.exit_reason}}</textarea>
                 </div>
               </div>
             </div>
             
             <!-- 액션 버튼 -->
             <div class="action-section">
               <button type="submit" class="btn btn-success btn-sm">저장</button>
               <button type="button" class="btn btn-secondary btn-sm" onclick="ShowDetail({{trade.id}});">취소</button>
             </div>
           </div>
        </form>
        </td>
      </tr>
      {% endfor %}
  </table>
</div>
{% endblock content2 %}

{% block script %}

<link rel="stylesheet" href="{% static 'css/trading.css' %}">
<script>
// 매매내역 디테일 드롭다운 보이기
var ShowDetail = function(id){
  if($('#'+id).css('display') == 'none' & $('#'+id+'-mod').css('display')=='none'){
     $('#'+id).css('display', 'table-row');
  } else {
    $('#'+id).css('display', 'none'); 
    $('#'+id+'-mod').css('display','none');
  }
};

var ShowUpdateDetal = function(id){
  $('#'+id).css('display','none');
  $('#'+id+'-mod').css('display','table-row');

}


</script>
{% endblock script%}

{% extends "trading/futures/base.html"%}
{% load humanize %}
{% load static %}
{% load trading_filters %}

{% block content %}
<div class='container-mobile'>
  <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
  <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid #f0f0f0;">
    <a href="{% url 'futurestrade' page=1 %}"
       style="flex: 1; padding: 12px; text-align: center; text-decoration: none; font-weight: 600; color: #2962FF; border-bottom: 3px solid #2962FF; margin-bottom: -2px;">
      ê±°ë˜ ë‚´ì—­
    </a>
    <a href="{% url 'transaction' page=1 %}"
       style="flex: 1; padding: 12px; text-align: center; text-decoration: none; font-weight: 500; color: #757575;">
      ì²´ê²° ê¸°ë¡
    </a>
  </div>

  <!-- í•„í„° ë°” (ê°„ì†Œí™”) -->
  <div class="filter-bar" style="margin-bottom: 16px;">
    <button class="filter-btn active" data-filter="week">ì´ë²ˆ ì£¼</button>
    <button class="filter-btn" data-filter="month">ì´ë²ˆ ë‹¬</button>
    <button class="filter-btn" data-filter="all">ì „ì²´</button>
  </div>

  <!-- ê±°ë˜ ëª©ë¡ ì»¨í…Œì´ë„ˆ -->
  <div id="trades-container">

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ (ìƒë‹¨) -->
  {% if is_paginated %}
    <nav aria-label="Page navigator" style="margin-bottom: 16px;">
      <ul class="pagination pagination-sm justify-content-center">
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=1 %}?filter={{ current_filter }}" aria-label="First">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.previous %}?filter={{ current_filter }}" aria-label="Previous">
            <span aria-hidden="true">&lt;</span>
          </a>
        </li>
        {% for page in page_obj.rng %}
          {% if page_obj.page == page %}
            <li class="page-item active">
              <a class="page-link" href="">{{page}}</a>
            </li>
          {% else %}
            <li class="page-item">
              <a class="page-link" href="{% url 'futurestrade' page=page %}?filter={{ current_filter }}">{{page}}</a>
            </li>
          {% endif %}
        {% endfor %}
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.next %}?filter={{ current_filter }}" aria-label="Next">
            <span aria-hidden="true">&gt;</span>
          </a>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.num_page %}?filter={{ current_filter }}" aria-label="Last">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  {% endif %}

  <!-- ê±°ë˜ ì¹´ë“œ ëª©ë¡ -->
  {% for trade, entries, exits, cons in data %}
  <div class="trade-card" onclick="toggleDetail('{{trade.id}}')"
       {% if trade.is_open %}
       style="background: linear-gradient(135deg, #fff9e6 0%, #fffbf0 100%); border: 2px solid #ff9800; box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);"
       {% endif %}>
    <div class="trade-header">
      <div class="instrument">
        <span class="symbol" style="font-size: 18px; font-weight: bold; color: #333;">{{ trade.instrument.name }}</span>
        <span class="name" style="font-size: 12px; color: #757575;">{{ trade.instrument.symbol }}</span>
      </div>
      <div class="profit {% if trade.realized_profit > 0 %}positive{% else %}negative{% endif %}">
        {% if trade.realized_profit >= 0 %}+{% else %}-{% endif %}{{ trade.instrument.currency.symbol|currency_symbol }}{{ trade.realized_profit|floatformat:0|intcomma|cut:"-" }}
      </div>
    </div>

    <div class="trade-body">
      <div class="position {% if trade.position == 1 %}long{% else %}short{% endif %}">
        {% if trade.position == 1 %}Long{% else %}Short{% endif %}
      </div>
      <div class="date">
        {{ trade.pub_date|date:"m/d H:i" }} â†’ {% if trade.is_open %}ì§„í–‰ì¤‘{% else %}{{ trade.end_date|date:"m/d H:i" }}{% endif %}
      </div>
      {% if trade.is_open %}
      <div class="duration" data-start="{{ trade.pub_date|date:'c' }}" id="duration-{{ trade.id }}">
        ê²½ê³¼: ê³„ì‚° ì¤‘...
      </div>
      {% elif trade.duration %}
      <div class="duration">{{ trade.duration }}</div>
      {% endif %}
    </div>

    <div class="trade-tags">
      {% for tag in trade.entry_tags.all %}
      <span class="tag">{{ tag.name }}</span>
      {% endfor %}
      {% if trade.is_open %}
      <span class="tag" style="background: #ff9800; color: #fff; font-weight: 600;">
        ğŸ”¥ ì§„í–‰ì¤‘ - {% if trade.type == 'Option' %}ì˜µì…˜{% elif trade.type == 'Futures' %}ì„ ë¬¼{% else %}{{ trade.type }}{% endif %}
      </span>
      {% endif %}
    </div>

    <div class="trade-footer">
      <span>ì§„ì…: {{ trade.avg_entry_price.normalize|floatformat:trade.instrument.decimal_places|intcomma }}</span>
      <span>ì²­ì‚°: {{ trade.avg_exit_price.normalize|floatformat:trade.instrument.decimal_places|intcomma }}</span>
      <span>{{ trade.realized_profit_ticks|floatformat:1|intcomma }} ticks</span>
    </div>
  </div>

  <!-- ê±°ë˜ ìƒì„¸ (í¼ì¹¨) -->
  <div id="detail-{{trade.id}}" style="display:none; margin-top: -12px; margin-bottom: 12px;">
    <div class="card">
      <h6 style="margin-bottom: 12px; font-weight: 600;">ê±°ë˜ ìƒì„¸</h6>

      <!-- ê¸°ë³¸ ì •ë³´ ê·¸ë¦¬ë“œ -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
        <div>
          <div style="font-size: 12px; color: #757575;">í‰ê· ë§¤ì…ê°€</div>
          <div style="font-weight: 600;">{{ trade.avg_entry_price.normalize|floatformat:trade.instrument.decimal_places|intcomma }}</div>
        </div>
        <div>
          <div style="font-size: 12px; color: #757575;">í‰ê· ì²­ì‚°ê°€</div>
          <div style="font-weight: 600;">{{ trade.avg_exit_price.normalize|floatformat:trade.instrument.decimal_places|intcomma }}</div>
        </div>
        <div>
          <div style="font-size: 12px; color: #757575;">ì†ì ˆê°€</div>
          <div style="font-weight: 600;">{% if trade.stop_price %}{{ trade.stop_price.normalize|intcomma }}{% else %}-{% endif %}</div>
        </div>
        <div>
          <div style="font-size: 12px; color: #757575;">íƒ€ì„í”„ë ˆì„</div>
          <div style="font-weight: 600;">{{ trade.timeframe|default:"-" }}</div>
        </div>
        <div>
          <div style="font-size: 12px; color: #757575;">ë©˜íƒˆ</div>
          <div style="font-weight: 600;">{{ trade.mental|default:"-" }}</div>
        </div>
        <div>
          <div style="font-size: 12px; color: #757575;">ìˆ˜ìˆ˜ë£Œ</div>
          <div style="font-weight: 600;">{{ trade.instrument.currency.symbol|currency_symbol }}{{ trade.commission.normalize|intcomma }}</div>
        </div>
      </div>

      <!-- ì§„ì…/ì²­ì‚° ì´ìœ  -->
      <div style="margin-bottom: 12px;">
        <div style="font-size: 12px; color: #757575; margin-bottom: 4px;">ì§„ì… ì „ëµ</div>
        <div>{{ trade.entry_strategy.name|default:"-" }}</div>
        {% if trade.entry_reason %}
        <div style="margin-top: 4px; padding: 8px; background: #f5f5f5; border-radius: 8px; font-size: 13px;">
          {{ trade.entry_reason|safe }}
        </div>
        {% endif %}
      </div>

      <div style="margin-bottom: 12px;">
        <div style="font-size: 12px; color: #757575; margin-bottom: 4px;">ì²­ì‚° ì „ëµ</div>
        <div>{{ trade.exit_strategy.name|default:"-" }}</div>
        {% if trade.exit_reason %}
        <div style="margin-top: 4px; padding: 8px; background: #f5f5f5; border-radius: 8px; font-size: 13px;">
          {{ trade.exit_reason|safe }}
        </div>
        {% endif %}
      </div>

      <!-- ìˆ˜ì • ë²„íŠ¼ -->
      <button class="btn btn-primary btn-sm w-100"
              onclick="openEditModal({{trade.id}}, '{{trade.mental|default:''}}', {{trade.entry_strategy.id|default:'null'}}, {{trade.exit_strategy.id|default:'null'}}, {{trade.stop_price|default:'null'}}, '{{trade.entry_reason|default:''|escapejs}}', '{{trade.exit_reason|default:''|escapejs}}'); event.stopPropagation();">
        ìˆ˜ì •
      </button>
    </div>
  </div>
  {% endfor %}

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius: 12px;">
        <div class="modal-header" style="border-bottom: 1px solid #f0f0f0;">
          <h6 class="modal-title" style="font-weight: 600;">ê±°ë˜ ìˆ˜ì •</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form method="post" action="{% url 'futurestrade' page=1 %}">
          {% csrf_token %}
          <input type="hidden" name="id" id="edit-id">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ë©˜íƒˆ</label>
              <select name="mental" id="edit-mental" class="form-select form-select-sm">
                <option value="">-</option>
                <option value="Good">Good</option>
                <option value="Normal">Normal</option>
                <option value="Bad">Bad</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ì§„ì… ì „ëµ</label>
              <select name="entry_strategy" id="edit-entry-strategy" class="form-select form-select-sm">
                <option value="">-</option>
                {% for strategy in entry_strategies %}
                <option value="{{strategy.id}}">{{strategy.name}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ì²­ì‚° ì „ëµ</label>
              <select name="exit_strategy" id="edit-exit-strategy" class="form-select form-select-sm">
                <option value="">-</option>
                {% for strategy in exit_strategies %}
                <option value="{{strategy.id}}">{{strategy.name}}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ì†ì ˆê°€</label>
              <input type="number" name="stopprice" id="edit-stop-price" class="form-control form-control-sm" step="0.01">
            </div>

            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ì§„ì… ì´ìœ </label>
              <textarea name="entryreason" id="edit-entry-reason" class="form-control form-control-sm" rows="3"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ì²­ì‚° ì´ìœ </label>
              <textarea name="exitreason" id="edit-exit-reason" class="form-control form-control-sm" rows="3"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ì§„ì… íƒœê·¸ (ì„¸ë¯¸ì½œë¡ ìœ¼ë¡œ êµ¬ë¶„)</label>
              <input type="text" name="entrytags" id="edit-entry-tags" class="form-control form-control-sm" placeholder="ì˜ˆ: ì§€ì§€; ëŒíŒŒ">
            </div>

            <div class="mb-3">
              <label class="form-label" style="font-size: 13px; font-weight: 600;">ì²­ì‚° íƒœê·¸ (ì„¸ë¯¸ì½œë¡ ìœ¼ë¡œ êµ¬ë¶„)</label>
              <input type="text" name="exittags" id="edit-exit-tags" class="form-control form-control-sm" placeholder="ì˜ˆ: ëª©í‘œë„ë‹¬; ì†ì ˆ">
            </div>
          </div>
          <div class="modal-footer" style="border-top: 1px solid #f0f0f0;">
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ì·¨ì†Œ</button>
            <button type="submit" class="btn btn-primary btn-sm">ì €ì¥</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ë¹ˆ ìƒíƒœ -->
  {% if not data %}
  <div class="empty-state">
    <p>ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>
  </div>
  {% endif %}

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ (í•˜ë‹¨) -->
  {% if is_paginated %}
    <nav aria-label="Page navigator" style="margin-top: 16px;">
      <ul class="pagination pagination-sm justify-content-center">
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=1 %}?filter={{ current_filter }}">ì²˜ìŒ</a>
        </li>
        <li class="page-item {% if page_obj.page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.previous %}?filter={{ current_filter }}">ì´ì „</a>
        </li>
        <li class="page-item active">
          <span class="page-link">{{ page_obj.page }} / {{ page_obj.num_page }}</span>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.next %}?filter={{ current_filter }}">ë‹¤ìŒ</a>
        </li>
        <li class="page-item {% if page_obj.page == page_obj.num_page %}disabled{% endif %}">
          <a class="page-link" href="{% url 'futurestrade' page=page_obj.num_page %}?filter={{ current_filter }}">ë§ˆì§€ë§‰</a>
        </li>
      </ul>
    </nav>
  {% endif %}
  </div> <!-- trades-container ë‹«ê¸° -->
</div>
{% endblock %}

{% block script %}
<script>
// ê±°ë˜ ìƒì„¸ í† ê¸€
function toggleDetail(id) {
  const detail = document.getElementById('detail-' + id);
  if (detail.style.display === 'none') {
    // ëª¨ë“  ë‹¤ë¥¸ ìƒì„¸ ë‹«ê¸°
    document.querySelectorAll('[id^="detail-"]').forEach(el => {
      el.style.display = 'none';
    });
    detail.style.display = 'block';
  } else {
    detail.style.display = 'none';
  }
}

// í•„í„° ë²„íŠ¼
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const filter = this.getAttribute('data-filter');
    window.location.href = "{% url 'futurestrade' page=1 %}?filter=" + filter;
  });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ í˜„ì¬ í•„í„° ìƒíƒœ ë³µì›
const urlParams = new URLSearchParams(window.location.search);
const currentFilter = urlParams.get('filter') || 'week';
document.querySelectorAll('.filter-btn').forEach(btn => {
  if (btn.getAttribute('data-filter') === currentFilter) {
    btn.classList.add('active');
  } else {
    btn.classList.remove('active');
  }
});

// ì§„í–‰ì¤‘ì¸ ê±°ë˜ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('[data-start]').forEach(function(element) {
    const startTime = new Date(element.getAttribute('data-start'));
    const now = new Date();
    const elapsed = now - startTime;

    const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));
    const hours = Math.floor((elapsed % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));

    let timeText = 'ê²½ê³¼: ';
    if (days > 0) {
      timeText += `${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„`;
    } else if (hours > 0) {
      timeText += `${hours}ì‹œê°„ ${minutes}ë¶„`;
    } else {
      timeText += `${minutes}ë¶„`;
    }

    element.textContent = timeText;
  });
});

// ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
function openEditModal(id, mental, entryStrategy, exitStrategy, stopPrice, entryReason, exitReason) {
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-mental').value = mental || '';
  document.getElementById('edit-entry-strategy').value = entryStrategy || '';
  document.getElementById('edit-exit-strategy').value = exitStrategy || '';
  document.getElementById('edit-stop-price').value = stopPrice || '';
  document.getElementById('edit-entry-reason').value = entryReason || '';
  document.getElementById('edit-exit-reason').value = exitReason || '';

  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}
</script>
{% endblock %}
